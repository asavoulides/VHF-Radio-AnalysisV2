<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Police Scanner Command Center - Live Intelligence Dashboard</title>
    <!-- Version: 2.0 - Analytics Feature Added - October 8, 2025 -->

    <!-- External Libraries -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Professional Monochrome Color Palette */
        --primary-navy: #1e293b;
        --primary-dark: #0f172a;
        --accent-blue: #3b82f6;
        --accent-red: #dc2626;
        --accent-green: #16a34a;
        --accent-amber: #d97706;

        /* Neutrals */
        --dark-950: #020617;
        --dark-900: #0f172a;
        --dark-800: #1e293b;
        --dark-700: #334155;
        --dark-600: #475569;
        --dark-500: #64748b;
        --light-400: #94a3b8;
        --light-300: #cbd5e1;
        --light-200: #e2e8f0;
        --light-100: #f1f5f9;
        --white: #ffffff;

        /* Glass Effects */
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);

        /* Professional Single Colors (No Gradients) */
        --primary-solid: var(--primary-navy);
        --emergency-solid: var(--accent-red);
        --success-solid: var(--accent-green);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--dark-900);
        color: var(--white);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Header */
      .main-header {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--glass-border);
        padding: 1.5rem 0;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--glass-shadow);
      }

      .header-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--white);
        margin: 0;
      }

      .live-badge {
        background: var(--emergency-solid);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
      }

      .connection-status.connected {
        color: var(--accent-green);
      }

      .connection-status.disconnected {
        color: var(--accent-red);
      }

      /* Main Layout */
      .main-container {
        padding: 2rem 0;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 3fr;
        gap: 2rem;
        height: calc(100vh - 200px);
      }

      /* Left Panel - Incident Feed */
      .incident-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        overflow-y: auto;
      }

      /* Right Panel - Map (Fixed Position) */
      .map-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        box-shadow: var(--glass-shadow);
        position: sticky;
        top: 2rem;
        height: calc(100vh - 250px);
      }

      .stats-overview {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .stat-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: var(--glass-shadow);
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        border-color: var(--accent-cyan);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--accent-blue);
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: var(--light-400);
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .incident-feed {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 1.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        box-shadow: var(--glass-shadow);
      }

      .feed-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--glass-border);
      }

      .feed-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--white);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .feed-counter {
        color: var(--accent-cyan);
        font-size: 0.875rem;
        font-weight: 600;
      }

      .feed-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      /* Filter Panel Styles */
      .filter-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: all 0.3s ease;
        display: block !important;
        visibility: visible !important;
      }

      .filter-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--glass-border);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-header:hover {
        background: rgba(255, 255, 255, 0.02);
      }

      .filter-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--white);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-toggle {
        background: none;
        border: none;
        color: var(--light-400);
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-toggle:hover {
        color: var(--accent-blue);
        transform: scale(1.1);
      }

      .filter-toggle.collapsed {
        transform: rotate(-90deg);
      }

      .filter-content {
        padding: 1.25rem;
        transition: all 0.3s ease;
        max-height: 300px;
        overflow-y: auto;
      }

      .filter-content.collapsed {
        max-height: 0;
        padding: 0 1.25rem;
        overflow: hidden;
      }

      .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .filter-btn {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--white);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .filter-btn:hover {
        border-color: var(--accent-blue);
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
      }

      .filter-btn.active {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: var(--white);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }

      .filter-btn.zero-count {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .filter-btn.zero-count:hover {
        transform: none;
        border-color: var(--glass-border);
        background: var(--glass-bg);
      }

      .feed-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 0.5rem;
      }

      .feed-content::-webkit-scrollbar {
        width: 6px;
      }

      .feed-content::-webkit-scrollbar-track {
        background: var(--dark-800);
        border-radius: 3px;
      }

      .feed-content::-webkit-scrollbar-thumb {
        background: var(--accent-cyan);
        border-radius: 3px;
      }

      .map-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--glass-border);
      }

      .map-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--white);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .map-counter {
        color: var(--accent-emerald);
        font-size: 0.875rem;
        font-weight: 600;
      }

      #incidentMap {
        flex: 1;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      /* Incident Cards */
      .incident-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        margin-left: 0.5rem;
        margin-right: 0.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        backdrop-filter: blur(10px);
        transform-origin: center center;
        position: relative;
      }

      .incident-card:hover {
        border-color: var(--accent-cyan);
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(6, 182, 212, 0.2);
      }

      .incident-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 0.75rem;
      }

      .incident-type-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Comprehensive Incident Type Colors */
      .type-assault_domestic,
      .type-assault-domestic {
        background: #dc2626;
        color: white;
      }

      .type-theft_burglary,
      .type-theft-burglary {
        background: #7c2d12;
        color: white;
      }

      .type-disturbance_noise,
      .type-disturbance-noise {
        background: #d97706;
        color: white;
      }

      .type-weapons_shots_fired,
      .type-weapons-shots-fired {
        background: #991b1b;
        color: white;
      }

      .type-traffic_stop,
      .type-traffic-stop {
        background: #2563eb;
        color: white;
      }

      .type-motor_vehicle_accident,
      .type-motor-vehicle-accident {
        background: #dc2626;
        color: white;
      }

      .type-medical {
        background: #dc2626;
        color: white;
      }

      .type-fire_alarm,
      .type-fire-alarm {
        background: #ea580c;
        color: white;
      }

      .type-structure_fire,
      .type-structure-fire {
        background: #dc2626;
        color: white;
      }

      .type-brush_vehicle_fire,
      .type-brush-vehicle-fire {
        background: #ea580c;
        color: white;
      }

      .type-gas_electrical_hazard,
      .type-gas-electrical-hazard {
        background: #d97706;
        color: white;
      }

      .type-wires_down,
      .type-wires-down {
        background: #ca8a04;
        color: white;
      }

      .type-hazmat {
        background: #7c2d12;
        color: white;
      }

      .type-animal_complaint,
      .type-animal-complaint {
        background: #16a34a;
        color: white;
      }

      .type-welfare_check,
      .type-welfare-check {
        background: #0891b2;
        color: white;
      }

      .type-suspicious_activity,
      .type-suspicious-activity {
        background: #7c3aed;
        color: white;
      }

      .type-missing_person,
      .type-missing-person {
        background: #be185d;
        color: white;
      }

      .type-alarm_burglar_panic,
      .type-alarm-burglar-panic {
        background: #dc2626;
        color: white;
      }

      .type-unknown,
      .type-other {
        background: var(--dark-600);
        color: white;
      }

      /* Legacy type support */
      .type-fire_emergency {
        background: var(--emergency-solid);
      }
      .type-medical_emergency {
        background: var(--accent-red);
      }
      .type-traffic_violation {
        background: var(--accent-amber);
      }
      .type-police_response {
        background: var(--accent-blue);
      }
      .type-public_safety {
        background: var(--primary-navy);
      }

      .incident-time {
        color: var(--light-400);
        font-size: 0.875rem;
        font-weight: 500;
      }

      .incident-transcript {
        color: var(--white);
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.02);
        padding: 0.75rem;
        border-radius: 8px;
        border-left: 3px solid var(--accent-cyan);
      }

      .incident-streetview {
        margin-bottom: 1rem;
        border-radius: 8px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--glass-border);
      }

      .streetview-label {
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        color: var(--light-400);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .streetview-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
        display: block;
        transition: all 0.3s ease;
        cursor: pointer;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .streetview-image:hover {
        transform: scale(1.01);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }

      .incident-streetview {
        margin-bottom: 1rem;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .streetview-label {
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        color: var(--light-400);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .streetview-image {
        width: 100%;
        height: 280px;
        object-fit: cover;
        display: block;
        transition: all 0.3s ease;
        cursor: pointer;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .streetview-image:hover {
        transform: scale(1.01);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }

      .incident-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .meta-item {
        background: rgba(255, 255, 255, 0.02);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .meta-label {
        color: var(--light-400);
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
      }

      .meta-value {
        color: var(--white);
        font-size: 0.875rem;
        font-weight: 600;
      }

      .incident-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        background: var(--glass-bg);
        color: var(--white);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .action-btn:hover {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
        transform: translateY(-1px);
      }

      .action-btn.play {
        background: var(--success-solid);
        border-color: var(--accent-green);
      }

      .action-btn.play:hover {
        background: var(--accent-green);
        border-color: var(--accent-green);
        color: var(--white);
      }

      .action-btn.analytics-btn {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.2),
          rgba(147, 51, 234, 0.2)
        );
        border-color: rgba(59, 130, 246, 0.4);
      }

      .action-btn.analytics-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.3),
          rgba(147, 51, 234, 0.3)
        );
        border-color: var(--accent-blue);
        color: var(--accent-blue);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }

      .confidence-meter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .confidence-bar {
        width: 60px;
        height: 4px;
        background: var(--dark-700);
        border-radius: 2px;
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        background: var(--success-solid);
        transition: width 0.3s ease;
      }

      .confidence-text {
        color: var(--light-400);
        font-size: 0.75rem;
        font-weight: 600;
      }

      /* Loading States */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        color: var(--light-400);
        font-size: 1rem;
      }

      .loading i {
        margin-right: 0.75rem;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
          height: auto;
        }

        .map-panel {
          height: 500px;
        }
      }

      @media (max-width: 768px) {
        .stats-overview {
          grid-template-columns: 1fr;
        }

        .incident-meta {
          grid-template-columns: 1fr;
        }

        .main-container {
          padding: 1rem 0;
        }

        .dashboard-grid {
          gap: 1rem;
        }
      }

      /* Audio Player */
      .audio-player {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 1rem;
        box-shadow: var(--glass-shadow);
        z-index: 1000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
      }

      .audio-player.active {
        transform: translateY(0);
        opacity: 1;
      }

      .audio-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .audio-info {
        color: var(--white);
        font-size: 0.875rem;
        font-weight: 500;
      }

      /* Custom Leaflet Styling */
      .leaflet-popup-content-wrapper {
        background: var(--dark-800);
        color: var(--white);
        border-radius: 8px;
        box-shadow: var(--glass-shadow);
      }

      .leaflet-popup-content {
        margin: 1rem;
      }

      .leaflet-popup-tip {
        background: var(--dark-800);
      }

      /* Color Mode Dropdown Styling */
      #colorMode {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="5"><path fill="%23e5e7eb" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 28px;
      }

      #colorMode option {
        background: #1f2937 !important;
        color: #e5e7eb !important;
        padding: 4px 8px;
      }

      #colorMode:hover {
        background-color: #374151;
      }

      #colorMode:focus {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
      }

      /* Callsign Button Styles */
      .callsign-btn {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        color: var(--white);
        padding: 0.6rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--glass-shadow);
      }

      .callsign-btn:hover {
        border-color: var(--accent-blue);
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
      }

      /* Callsign Modal Styles */
      .callsign-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .callsign-modal.active {
        display: flex;
      }

      .callsign-modal-content {
        background: var(--dark-800);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        max-width: 900px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        50% {
          box-shadow: 0 0 20px 10px rgba(59, 130, 246, 0.3);
        }
      }

      .callsign-modal-header {
        padding: 2rem;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px 20px 0 0;
      }

      .callsign-modal-header h2 {
        color: var(--white);
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .callsign-modal-close {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--white);
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.25rem;
      }

      .callsign-modal-close:hover {
        background: var(--accent-red);
        border-color: var(--accent-red);
        transform: rotate(90deg);
      }

      .callsign-modal-body {
        padding: 2rem;
      }

      .callsign-category {
        margin-bottom: 2rem;
      }

      .callsign-category:last-child {
        margin-bottom: 0;
      }

      .callsign-category-title {
        color: var(--accent-blue);
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--accent-blue);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .callsign-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 0.75rem;
      }

      .callsign-item {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.3s ease;
      }

      .callsign-item:hover {
        border-color: var(--accent-blue);
        background: rgba(59, 130, 246, 0.05);
        transform: translateX(4px);
      }

      .callsign-number {
        background: var(--accent-blue);
        color: var(--white);
        padding: 0.35rem 0.7rem;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.875rem;
        white-space: nowrap;
        min-width: 80px;
        text-align: center;
      }

      .callsign-description {
        color: var(--light-300);
        font-size: 0.875rem;
        font-weight: 500;
      }

      /* Scrollbar Styles for Modal */
      .callsign-modal-content::-webkit-scrollbar {
        width: 8px;
      }

      .callsign-modal-content::-webkit-scrollbar-track {
        background: var(--dark-900);
        border-radius: 4px;
      }

      .callsign-modal-content::-webkit-scrollbar-thumb {
        background: var(--accent-blue);
        border-radius: 4px;
      }

      .callsign-modal-content::-webkit-scrollbar-thumb:hover {
        background: var(--accent-cyan);
      }

      /* Callsign Tooltip Styles */
      .callsign-tooltip {
        position: relative;
        color: var(--accent-blue);
        font-weight: 600;
        cursor: pointer;
        border-bottom: 2px dotted var(--accent-blue);
        padding: 0 2px;
        transition: all 0.2s ease;
      }

      .callsign-tooltip:hover {
        color: var(--accent-cyan);
        border-bottom-color: var(--accent-cyan);
        transform: scale(1.05);
      }

      .callsign-tooltip:active {
        transform: scale(0.95);
      }

      .callsign-tooltip-content {
        visibility: hidden;
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dark-900);
        color: var(--white);
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
        z-index: 1000;
        border: 1px solid var(--accent-blue);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: all 0.2s ease;
        pointer-events: none;
      }

      /* Analytics Modal Styles */
      .analytics-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(12px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        animation: fadeIn 0.3s ease-out;
      }

      .analytics-modal.active {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .analytics-modal-content {
        background: linear-gradient(
          135deg,
          var(--dark-800) 0%,
          var(--dark-900) 100%
        );
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 24px;
        max-width: 1000px;
        width: 100%;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.7),
          0 0 60px rgba(59, 130, 246, 0.15);
        animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
      }

      @keyframes modalSlideUp {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .analytics-modal-header {
        padding: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(147, 51, 234, 0.1)
        );
        backdrop-filter: blur(20px);
        border-radius: 24px 24px 0 0;
        flex-shrink: 0;
      }

      .analytics-modal-title {
        color: var(--white);
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .analytics-modal-title i {
        background: linear-gradient(135deg, var(--accent-blue), #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 2rem;
      }

      .analytics-modal-close {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--white);
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.25rem;
      }

      .analytics-modal-close:hover {
        background: var(--accent-red);
        border-color: var(--accent-red);
        transform: rotate(90deg);
        box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
      }

      .analytics-modal-body {
        padding: 2rem;
        overflow-y: auto;
        flex: 1;
      }

      .analytics-modal-body::-webkit-scrollbar {
        width: 10px;
      }

      .analytics-modal-body::-webkit-scrollbar-track {
        background: var(--dark-900);
        border-radius: 5px;
      }

      .analytics-modal-body::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--accent-blue), #8b5cf6);
        border-radius: 5px;
      }

      .analytics-modal-body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #2563eb, #7c3aed);
      }

      .analytics-section {
        margin-bottom: 2rem;
      }

      .analytics-section:last-child {
        margin-bottom: 0;
      }

      .analytics-section-title {
        color: var(--accent-blue);
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(59, 130, 246, 0.3);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .analytics-section-title i {
        background: linear-gradient(135deg, var(--accent-blue), #06b6d4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .analytics-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .analytics-card:hover {
        border-color: rgba(59, 130, 246, 0.4);
        background: rgba(59, 130, 246, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
      }

      .analytics-card-label {
        color: var(--light-400);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .analytics-card-label i {
        color: var(--accent-blue);
        font-size: 0.85rem;
      }

      .analytics-card-value {
        color: var(--white);
        font-size: 1rem;
        font-weight: 600;
        word-break: break-word;
      }

      .analytics-card-value.large {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-blue), #06b6d4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .analytics-transcript {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1.25rem;
        border-radius: 12px;
        color: var(--light-200);
        font-size: 0.95rem;
        line-height: 1.6;
        font-style: italic;
        border-left: 4px solid var(--accent-blue);
      }

      .analytics-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid;
      }

      .analytics-badge.success {
        background: rgba(22, 163, 74, 0.15);
        color: var(--accent-green);
        border-color: var(--accent-green);
      }

      .analytics-badge.warning {
        background: rgba(217, 119, 6, 0.15);
        color: var(--accent-amber);
        border-color: var(--accent-amber);
      }

      .analytics-badge.error {
        background: rgba(220, 38, 38, 0.15);
        color: var(--accent-red);
        border-color: var(--accent-red);
      }

      .analytics-badge.info {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent-blue);
        border-color: var(--accent-blue);
      }

      .analytics-processing-timeline {
        position: relative;
        padding-left: 2rem;
      }

      .analytics-processing-timeline::before {
        content: "";
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(
          180deg,
          var(--accent-blue),
          rgba(59, 130, 246, 0.2)
        );
      }

      .analytics-timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
      }

      .analytics-timeline-item:last-child {
        padding-bottom: 0;
      }

      .analytics-timeline-item::before {
        content: "";
        position: absolute;
        left: -1.5rem;
        top: 0.25rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent-blue);
        border: 2px solid var(--dark-800);
        box-shadow: 0 0 12px var(--accent-blue);
      }

      .analytics-timeline-title {
        color: var(--white);
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .analytics-timeline-desc {
        color: var(--light-400);
        font-size: 0.875rem;
      }

      .analytics-link {
        color: var(--accent-blue);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        transition: all 0.2s ease;
      }

      .analytics-link:hover {
        color: #06b6d4;
        text-decoration: underline;
      }

      .callsign-tooltip:hover .callsign-tooltip-content {
        visibility: visible;
        opacity: 1;
      }

      .callsign-tooltip-content::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: var(--accent-blue);
      }

      .callsign-tooltip-content .tooltip-hint {
        display: block;
        font-size: 0.65rem;
        color: var(--light-400);
        margin-top: 0.25rem;
        font-style: italic;
      }

      .callsign-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid var(--accent-blue);
        padding: 2px 6px;
        border-radius: 4px;
        color: var(--accent-blue);
        font-weight: 600;
        font-size: 0.85em;
      }

      /* ===== STUNNING PAGE LOADER ===== */
      .page-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #0f172a 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 1;
        transition: opacity 0.5s ease-out;
        overflow: hidden;
      }

      .page-loader::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 600px;
        height: 600px;
        background: radial-gradient(
          circle,
          rgba(59, 130, 246, 0.15) 0%,
          transparent 70%
        );
        animation: loaderPulse 3s ease-in-out infinite;
      }

      .page-loader.fade-out {
        opacity: 0;
        pointer-events: none;
      }

      .loader-content {
        position: relative;
        z-index: 2;
        text-align: center;
        animation: loaderFadeIn 0.8s ease-out;
      }

      .loader-spinner {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto 2rem;
      }

      .spinner-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 3px solid transparent;
        border-radius: 50%;
        animation: spinRotate 2s linear infinite;
      }

      .spinner-ring:nth-child(1) {
        border-top-color: var(--accent-blue);
        animation-duration: 2s;
      }

      .spinner-ring:nth-child(2) {
        border-right-color: #06b6d4;
        animation-duration: 3s;
        animation-direction: reverse;
        width: 80%;
        height: 80%;
        top: 10%;
        left: 10%;
      }

      .spinner-ring:nth-child(3) {
        border-bottom-color: #8b5cf6;
        animation-duration: 4s;
        width: 60%;
        height: 60%;
        top: 20%;
        left: 20%;
      }

      .spinner-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2.5rem;
        color: var(--accent-blue);
        animation: iconPulse 2s ease-in-out infinite;
      }

      .loader-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 0.5rem;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .loader-subtitle {
        font-size: 1rem;
        color: var(--light-400);
        margin-bottom: 2rem;
        animation: subtitleFade 2s ease-in-out infinite;
      }

      .loader-progress {
        width: 300px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin: 0 auto;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
      }

      .loader-progress-bar {
        height: 100%;
        background: linear-gradient(
          90deg,
          #3b82f6 0%,
          #06b6d4 50%,
          #8b5cf6 100%
        );
        background-size: 200% 100%;
        border-radius: 10px;
        animation: progressSlide 2s ease-in-out infinite;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
      }

      @keyframes spinRotate {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes iconPulse {
        0%,
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.1);
          opacity: 0.8;
        }
      }

      @keyframes loaderPulse {
        0%,
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.3;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.2);
          opacity: 0.5;
        }
      }

      @keyframes loaderFadeIn {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes subtitleFade {
        0%,
        100% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes progressSlide {
        0% {
          background-position: 0% 0%;
          width: 0%;
        }
        50% {
          background-position: 100% 0%;
          width: 70%;
        }
        100% {
          background-position: 200% 0%;
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <!-- Beautiful Loading Screen -->
    <div id="pageLoader" class="page-loader">
      <div class="loader-content">
        <div class="loader-spinner">
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-icon">
            <i class="fas fa-satellite-dish"></i>
          </div>
        </div>
        <h2 class="loader-title">Police Scanner Intelligence Center</h2>
        <p class="loader-subtitle">Initializing live feed...</p>
        <div class="loader-progress">
          <div class="loader-progress-bar"></div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="main-header">
      <div class="container-fluid px-4">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="header-title">
              <i class="fas fa-radio"></i>
              Police Scanner Intelligence Center
              <span class="live-badge ms-3">Live {{ current_date }}</span>
            </h1>
          </div>
          <div class="col-md-6 text-end">
            <button class="callsign-btn" onclick="openCallsignModal()">
              <i class="fas fa-id-badge"></i>
              Call Signs
            </button>
            <div
              id="connectionStatus"
              class="connection-status connected"
              style="display: inline-flex; margin-left: 1rem"
            >
              <i class="fas fa-satellite-dish"></i>
              Connected
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Dashboard -->
    <main class="main-container">
      <div class="container-fluid px-4">
        <div class="dashboard-grid">
          <!-- Left Panel - Incident Feed -->
          <div class="incident-panel">
            <!-- Stats Overview -->
            <div class="stats-overview">
              <div class="stat-card">
                <div class="stat-value" id="totalToday">0</div>
                <div class="stat-label">Total Today</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="recentActivity">0</div>
                <div class="stat-label">Recent Activity</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="highPriorityPct">0%</div>
                <div class="stat-label">High Priority</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="activeLocations">0</div>
                <div class="stat-label">Active Locations</div>
              </div>
            </div>

            <!-- Live Incident Feed -->
            <div class="incident-feed">
              <div class="feed-header">
                <h3
                  class="feed-title"
                  style="
                    width: 100%;
                    text-align: center;
                    justify-content: center;
                  "
                >
                  <i class="fas fa-broadcast-tower"></i>
                  Live Incident Feed
                </h3>
                <div class="feed-counter" id="feedCounter">0 incidents</div>
              </div>

              <!-- Address Filter Panel -->
              <div class="filter-panel" id="addressFilterPanel">
                <div class="filter-header">
                  <h4 class="filter-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Filter by Location
                  </h4>
                  <button class="filter-toggle" id="addressFilterToggle">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                </div>
                <div class="filter-content" id="addressFilterContent">
                  <div class="filter-options">
                    <button
                      class="filter-btn active"
                      data-address-filter="all"
                      id="allAddressFilter"
                    >
                      All Locations (<span id="totalAddressCount">0</span>)
                    </button>
                    <button
                      class="filter-btn"
                      data-address-filter="with-address"
                      id="withAddressFilter"
                    >
                      With Address (<span id="withAddressCount">0</span>)
                    </button>
                    <button
                      class="filter-btn"
                      data-address-filter="no-address"
                      id="noAddressFilter"
                    >
                      No Address (<span id="noAddressCount">0</span>)
                    </button>
                  </div>
                </div>
              </div>

              <!-- Incident Type Filter Panel -->
              <div class="filter-panel" id="filterPanel">
                <div class="filter-header">
                  <h4 class="filter-title">
                    <i class="fas fa-filter"></i>
                    Filter by Incident Type
                  </h4>
                  <button class="filter-toggle" id="filterToggle">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                </div>
                <div class="filter-content" id="filterContent">
                  <div class="filter-options" id="filterOptions">
                    <button class="filter-btn active" data-type="all">
                      All Incidents (<span id="totalCount">0</span>)
                    </button>
                    <!-- Dynamic incident type buttons will be inserted here -->
                  </div>
                </div>
              </div>

              <div class="feed-content" id="liveFeed">
                <div class="loading">
                  <i class="fas fa-spinner"></i>
                  Loading live incidents...
                </div>
              </div>
            </div>
          </div>

          <!-- Right Panel - Interactive Map -->
          <div class="map-panel">
            <div class="map-header">
              <h3 class="map-title">
                <i class="fas fa-map-marked-alt"></i>
                Real-Time Incident Map
              </h3>
              <div
                class="map-counter"
                id="mapCounter"
                style="text-align: center"
              >
                0 incidents plotted
              </div>

              <!-- Color Coding Mode Selector -->
              <div
                style="
                  margin-top: 8px;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  font-size: 0.875rem;
                "
              >
                <label style="color: var(--light-300); font-weight: 500"
                  >Color Mode:</label
                >
                <select
                  id="colorMode"
                  onchange="changeColorMode()"
                  style="
                    background: #1f2937;
                    border: 1px solid #374151;
                    color: #e5e7eb;
                    padding: 6px 10px;
                    border-radius: 6px;
                    font-size: 0.875rem;
                    cursor: pointer;
                    transition: all 0.2s ease;
                  "
                  onmouseover="this.style.borderColor='#60a5fa'"
                  onmouseout="this.style.borderColor='#374151'"
                  onfocus="this.style.borderColor='#3b82f6'; this.style.outline='none'"
                  onblur="this.style.borderColor='#374151'"
                >
                  <option
                    value="incident-type"
                    style="background: #1f2937; color: #e5e7eb"
                  >
                    By Incident Type
                  </option>
                  <option
                    value="severity"
                    style="background: #1f2937; color: #e5e7eb"
                  >
                    By Severity Level
                  </option>
                  <option
                    value="time-elapsed"
                    style="background: #1f2937; color: #e5e7eb"
                  >
                    By Time Elapsed
                  </option>
                </select>
              </div>
            </div>
            <div id="incidentMap"></div>

            <!-- Dynamic Legend -->
            <div
              id="mapLegend"
              style="
                margin-top: 12px;
                padding: 12px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                backdrop-filter: blur(10px);
              "
            >
              <div
                style="
                  font-size: 0.875rem;
                  font-weight: 600;
                  margin-bottom: 8px;
                  color: #e2e8f0;
                "
              >
                <span id="legend-title">📍 Incident Categories</span>
              </div>
              <div
                id="legend-content"
                style="
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  flex-wrap: wrap;
                  font-size: 0.7rem;
                  line-height: 1.2;
                "
              >
                <!-- Dynamic legend content will be populated by updateMapLegend() -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Audio Player -->
    <div class="audio-player" id="audioPlayer">
      <div class="audio-controls">
        <button class="action-btn" id="audioPlayPause">
          <i class="fas fa-play"></i>
        </button>
        <div class="audio-info" id="audioInfo">
          Select an incident to play audio
        </div>
        <button class="action-btn" id="audioClose">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <audio id="audioElement" preload="none"></audio>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
      // Global variables
      let socket;
      let incidentMap;
      let mapCounter = 0;
      let currentAudio = null;
      let audioPlayer = null;
      let currentFilter = "all";
      let allIncidents = [];
      let incidentTypeCounts = {};
      let currentAddressFilter = "all";

      // Address filter function - defined early to ensure availability
      function passesAddressFilter(incident) {
        if (currentAddressFilter === "all") {
          return true;
        }

        const hasValidAddress =
          incident.formatted_address &&
          incident.formatted_address !== "Unknown" &&
          incident.formatted_address.trim() !== "" &&
          incident.formatted_address !== "Newton, MA, USA";

        if (currentAddressFilter === "with-address") {
          return hasValidAddress;
        } else if (currentAddressFilter === "no-address") {
          return !hasValidAddress;
        }

        return true;
      }

      // Hide loading screen when page is ready
      function hideLoader() {
        const loader = document.getElementById("pageLoader");
        if (loader) {
          setTimeout(() => {
            loader.classList.add("fade-out");
            setTimeout(() => {
              loader.style.display = "none";
            }, 500);
          }, 800); // Show loader for at least 800ms for smooth experience
        }
      }

      // Fallback: Hide loader after max 5 seconds
      window.addEventListener("load", function () {
        setTimeout(hideLoader, 100);
      });

      // Initialize application
      document.addEventListener("DOMContentLoaded", function () {
        initializeSocket();
        initializeMap();
        initializeAudioPlayer();
        initializeFilters();
        loadInitialData();
        updateMapLegend(); // Initialize legend with default color mode

        // Update connection status every 30 seconds
        setInterval(checkConnection, 30000);

        // Hide loader after everything is initialized
        hideLoader();
      });

      // Socket.IO Connection with proper configuration
      function initializeSocket() {
        socket = io({
          // Proper Socket.IO client configuration
          timeout: 20000, // 20 second connection timeout
          reconnection: true, // Enable auto-reconnection
          reconnectionDelay: 1000, // Start with 1 second delay
          reconnectionAttempts: 5, // Max 5 reconnection attempts
          maxReconnectionAttempts: 5,
          forceNew: false, // Reuse existing connection
          transports: ["websocket", "polling"], // Prefer websocket, fallback to polling
        });

        socket.on("connect", function () {
          updateConnectionStatus(true);
          // Only show connection notification on initial connect, not reconnects
          if (!sessionStorage.getItem("connected_once")) {
            showNotification("🔗 Live connection established", "success");
            sessionStorage.setItem("connected_once", "true");
          }
          socket.emit("ping");
        });

        socket.on("connection_confirmed", function (data) {
          // Connection confirmed - no notification needed
        });

        socket.on("pong", function (data) {
          // Connection active
        });

        socket.on("heartbeat", function (data) {
          updateConnectionStatus(true);
          // Only show notifications for significant activity
          if (data.new_count > 3) {
            showNotification(
              `💓 High activity - ${data.new_count} new incidents`,
              "info"
            );
          }
        });

        socket.on("live_status", function (data) {
          // Status update received
        });

        socket.on("disconnect", function () {
          updateConnectionStatus(false);
          showNotification(
            "⚠️ Connection lost - attempting to reconnect...",
            "warning"
          );
        });

        socket.on("initial_data", function (data) {
          // Store current address filter state to preserve it
          const savedAddressFilter = currentAddressFilter;

          // Process received data
          allIncidents = data.incidents || [];
          // Store globally for color mode switching
          window.allIncidents = allIncidents;
          console.log(
            "Loaded",
            allIncidents.length,
            "incidents into window.allIncidents"
          );

          // Update address filter counters
          setTimeout(updateAddressCounters, 100);

          const liveFeed = document.getElementById("liveFeed");
          liveFeed.innerHTML = "";
          processedIncidents.clear();
          clearMapMarkers();

          if (!data.incidents || data.incidents.length === 0) {
            liveFeed.innerHTML =
              '<div class="loading">No incidents found for today</div>';
          } else {
            // Sort incidents by ID (chronological order) then reverse for newest-first display
            const sortedIncidents = sortIncidentsByTime(data.incidents);
            sortedIncidents.forEach((incident) => {
              try {
                if (shouldShowIncident(incident)) {
                  addIncidentToFeed(incident, false);
                }
                addIncidentToMap(incident);
                processedIncidents.add(incident.id);
              } catch (error) {
                console.error(
                  `Error processing incident ${incident.id}:`,
                  error
                );
              }
            });
          }

          updateMapCounter();
          updateFeedCounter(getVisibleIncidentCount());

          // Store current address filter state to preserve it
          const savedInitialAddressFilter = currentAddressFilter;

          loadIncidentTypes();

          // Restore address filter state after a short delay
          setTimeout(() => {
            if (
              savedInitialAddressFilter &&
              savedInitialAddressFilter !== "all"
            ) {
              currentAddressFilter = savedInitialAddressFilter;
              // Re-activate the correct button
              const addressFilterButtons = document.querySelectorAll(
                ".address-filter-btn"
              );
              addressFilterButtons.forEach((btn) =>
                btn.classList.remove("active")
              );
              const targetBtn = document.querySelector(
                `[data-address-filter="${savedInitialAddressFilter}"]`
              );
              if (targetBtn) {
                targetBtn.classList.add("active");
              }
              updateAddressCounters();
              filterByType(currentFilter);
            }
          }, 200);
        });

        socket.on("new_incidents", function (data) {
          // Sort new incidents by ID to maintain chronological order
          const sortedNewIncidents = sortIncidentsByTime(data);

          sortedNewIncidents.forEach((incident) => {
            // Only add if not already processed (avoid duplicates)
            if (!processedIncidents.has(incident.id)) {
              // Add to allIncidents array
              allIncidents.push(incident);
              // Also update global array for color mode switching
              if (window.allIncidents) {
                window.allIncidents.push(incident);
              }

              if (shouldShowIncident(incident)) {
                addIncidentToFeed(incident, true);
              }
              addIncidentToMap(incident);
              processedIncidents.add(incident.id);
            }
          });

          updateMapCounter();
          updateFeedCounter(getVisibleIncidentCount());
          // Store current address filter state
          const savedNewIncidentsAddressFilter = currentAddressFilter;

          loadIncidentTypes();

          // Restore address filter state
          setTimeout(() => {
            if (
              savedNewIncidentsAddressFilter &&
              savedNewIncidentsAddressFilter !== currentAddressFilter
            ) {
              currentAddressFilter = savedNewIncidentsAddressFilter;
              updateAddressCounters();
              filterByType(currentFilter);
            }
          }, 100);

          // Show notification for new incidents (only for multiple incidents)
          if (data.length > 1) {
            showNotification(`🆕 ${data.length} new incidents received!`);
          }
        });

        // NEW: Handle incident updates (when background processing completes)
        socket.on("incident_updates", function (data) {
          console.log(`🔄 Received ${data.length} incident updates`);

          let updatedCount = 0;
          data.forEach((incident) => {
            // Find existing incident in allIncidents array
            const index = allIncidents.findIndex((i) => i.id === incident.id);
            if (index !== -1) {
              // Update the incident data in our array
              allIncidents[index] = incident;

              // Update the DOM card if it exists
              const card = document.querySelector(
                `[data-incident-id="${incident.id}"]`
              );
              if (card) {
                // Find the parent incident card
                const incidentCard = card.closest(".incident-card");
                if (incidentCard) {
                  // Get current scroll position to restore after update
                  const scrollY = window.scrollY;

                  // Create a new card HTML
                  const newCardHTML = createIncidentCard(incident);
                  const tempDiv = document.createElement("div");
                  tempDiv.innerHTML = newCardHTML;
                  const newCard = tempDiv.firstElementChild;

                  // Replace old card with new card (preserves position in feed)
                  incidentCard.replaceWith(newCard);

                  // Restore scroll position
                  window.scrollTo(0, scrollY);

                  // Add subtle flash effect to show update
                  newCard.style.animation = "pulse 0.5s ease-in-out";
                  setTimeout(() => {
                    newCard.style.animation = "";
                  }, 500);

                  updatedCount++;
                }
              }

              // Update map marker if it exists
              if (incident.latitude && incident.longitude) {
                updateIncidentMarker(incident);
              }
            }
          });

          if (updatedCount > 0) {
            console.log(`✅ Updated ${updatedCount} incident cards in the DOM`);
            // Optional: Show subtle notification
            // showNotification(`🔄 ${updatedCount} incident(s) updated with new information`);
          }
        });

        socket.on("data_update", function (data) {
          // Handle both single incident and array of incidents
          if (Array.isArray(data)) {
            // Array of incidents
            data.forEach((incident) => {
              if (!processedIncidents.has(incident.id)) {
                addLiveIncident(incident, true);
                addIncidentToMap(incident);
                processedIncidents.add(incident.id);
              }
            });
          } else if (data.incidents && Array.isArray(data.incidents)) {
            // Object with incidents array
            data.incidents.forEach((incident) => {
              if (!processedIncidents.has(incident.id)) {
                addLiveIncident(incident, true);
                addIncidentToMap(incident);
                processedIncidents.add(incident.id);
              }
            });
          } else if (data.id) {
            // Single incident object
            if (!processedIncidents.has(data.id)) {
              addLiveIncident(data, true);
              addIncidentToMap(data);
              processedIncidents.add(data.id);
            }
          }

          updateMapCounter();
          updateFeedCounter(document.querySelectorAll(".incident-card").length);
        });

        socket.on("forced_update", function (data) {
          // Process the forced update like new incidents
          if (data.incidents && data.incidents.length > 0) {
            data.incidents.forEach((incident) => {
              if (!processedIncidents.has(incident.id)) {
                addLiveIncident(incident, true);
                addIncidentToMap(incident);
                processedIncidents.add(incident.id);
              }
            });
            updateMapCounter();
            updateFeedCounter(
              document.querySelectorAll(".incident-card").length
            );
          }
        });

        socket.on("stats_update", function (stats) {
          updateStatsDisplay(stats);
        });

        socket.on("debug_info", function (info) {
          // Debug info received - no action needed in production
        });

        socket.on("monitoring_heartbeat", function (data) {
          // Update connection status to show monitoring is active
          updateConnectionStatus(true);
        });

        socket.on("error", function (error) {
          showNotification("⚠️ Connection error: " + error.message, "error");
        });

        // REDUCED polling to prevent race conditions and server overload
        setInterval(() => {
          if (socket.connected) {
            // Primary: Check for updates (legacy compatibility)
            socket.emit("check_for_updates");
          } else {
            updateConnectionStatus(false);
          }
        }, 30000); // REDUCED: Check every 30 seconds

        // REDUCED live incident polling (backup method only)
        setInterval(() => {
          if (socket.connected) {
            socket.emit("request_live_incidents");
          }
        }, 60000); // REDUCED: Check every 60 seconds

        // Connection health monitoring with REDUCED frequency
        setInterval(() => {
          if (socket.connected) {
            // Send ping for connection health (less frequent)
            socket.emit("ping");

            fetch("/api/health")
              .then((response) => response.json())
              .then((data) => {
                if (!data.monitoring_active) {
                  showNotification("⚠️ Server monitoring inactive", "warning");
                }
              })
              .catch((error) => {
                // Health check failed - no action needed
              });
          }
        }, 120000); // REDUCED: Health check every 2 minutes
      }

      // Initialize Leaflet Map
      function initializeMap() {
        // Center on Boston area
        incidentMap = L.map("incidentMap").setView([42.3601, -71.0589], 11);

        // Dark theme tile layer
        L.tileLayer(
          "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
          {
            attribution:
              '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: "abcd",
            maxZoom: 20,
          }
        ).addTo(incidentMap);
      }

      // Initialize Filters
      function initializeFilters() {
        const filterToggle = document.getElementById("filterToggle");
        const filterContent = document.getElementById("filterContent");

        // Ensure filter panel starts expanded (remove collapsed class if present)
        filterContent.classList.remove("collapsed");
        filterToggle.classList.remove("collapsed");

        filterToggle.addEventListener("click", function () {
          filterContent.classList.toggle("collapsed");
          filterToggle.classList.toggle("collapsed");
        });

        // Initialize address filter
        initializeAddressFilter();

        // NOTE: loadIncidentTypes() is called AFTER incidents are loaded in initial_data event
      }

      // Load incident types and their counts
      function loadIncidentTypes() {
        fetch("/api/incident_types")
          .then((response) => response.json())
          .then((data) => {
            updateFilterOptions(data);
            incidentTypeCounts = {};
            data.incident_types.forEach((item) => {
              incidentTypeCounts[item.type] = item.count;
            });
          })
          .catch((error) => {
            console.error("Error loading incident types:", error);
          });
      }

      // Update filter options with incident types
      function updateFilterOptions(data) {
        const filterOptions = document.getElementById("filterOptions");
        const totalCount = document.getElementById("totalCount");

        if (!filterOptions) {
          console.error("Filter options element not found!");
          return;
        }

        // Update total count
        totalCount.textContent = data.total_non_unknown || 0;

        // Clear existing dynamic buttons (keep "All Incidents" button)
        const existingButtons = filterOptions.querySelectorAll(
          '.filter-btn:not([data-type="all"])'
        );

        existingButtons.forEach((btn) => btn.remove());

        // Add incident type buttons
        data.incident_types.forEach((item) => {
          const button = document.createElement("button");
          button.className = `filter-btn ${
            item.count === 0 ? "zero-count" : ""
          }`;
          button.dataset.type = item.type;
          button.innerHTML = `${item.formatted} (${item.count})`;

          if (item.count > 0) {
            button.addEventListener("click", () => {
              filterByType(item.type);
            });
          }

          filterOptions.appendChild(button);
        });

        // Only add "All" button event listener if it doesn't already have one
        const allButton = filterOptions.querySelector('[data-type="all"]');
        if (allButton && !allButton.hasAttribute("data-listener-added")) {
          allButton.addEventListener("click", () => {
            filterByType("all");
          });
          allButton.setAttribute("data-listener-added", "true");
        } else if (allButton) {
        }
      }

      // Filter incidents by type
      function filterByType(type) {
        currentFilter = type;

        // Update active button
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        const targetButton = document.querySelector(`[data-type="${type}"]`);

        if (targetButton) {
          targetButton.classList.add("active");
        }

        // Start with all incidents
        let filtered = allIncidents;

        // Apply incident type filter
        if (type !== "all") {
          filtered = allIncidents.filter((incident) => {
            return incident.incident_type === type;
          });
        }

        // Apply address filter
        if (currentAddressFilter !== "all") {
          filtered = filtered.filter((incident) =>
            passesAddressFilter(incident)
          );
        }

        displayFilteredIncidents(filtered);

        updateFeedCounter(getVisibleIncidentCount());
      }

      // Display filtered incidents
      function displayFilteredIncidents(incidents) {
        const liveFeed = document.getElementById("liveFeed");
        liveFeed.innerHTML = "";

        if (incidents.length === 0) {
          liveFeed.innerHTML = `
            <div class="loading">
              No incidents found for the selected filter
            </div>
          `;
          return;
        }

        // Sort incidents by ID (newest first)
        const sortedIncidents = sortIncidentsByTime(incidents);

        sortedIncidents.forEach((incident) => {
          // CRITICAL FIX: Create incident HTML directly without duplicate check
          createIncidentHtml(incident);
        });
      }

      // Create incident HTML and add to feed (without duplicate check for filtering)
      function createIncidentHtml(incident) {
        const liveFeed = document.getElementById("liveFeed");

        // Clear loading message if it exists
        if (liveFeed.querySelector(".loading")) {
          liveFeed.innerHTML = "";
        }

        const incidentEl = document.createElement("div");
        incidentEl.className = "incident-card";
        incidentEl.dataset.incidentId = incident.id;

        // Get incident type class
        const typeClass = getIncidentTypeClass(incident.incident_type);

        // Calculate confidence percentage
        const confidencePercent = Math.round((incident.confidence || 0) * 100);

        // Simple transcript display - NO ANIMATIONS, NO ENHANCEMENTS
        const displayTranscript =
          incident.content || incident.transcript || "Processing transcript...";

        incidentEl.innerHTML = `
          <div class="incident-header">
            <span class="incident-type-badge ${typeClass}">
              ${formatIncidentType(incident.incident_type)}
            </span>
            <span class="incident-time">${incident.time_recorded}</span>
          </div>

          <div class="incident-transcript">
            ${displayTranscript}
          </div>

          <!-- ALWAYS SHOW ALL FIELDS - Static text, no animations -->
          <div class="incident-meta">
            <!-- TRANSCRIPT STATUS -->
            <div class="meta-item">
              <div class="meta-label">Transcript</div>
              <div class="meta-value">${
                displayTranscript.includes("Processing") ||
                displayTranscript.includes("Waiting") ||
                displayTranscript.includes("Transcribing")
                  ? "Processing transcript..."
                  : "Complete"
              }</div>
            </div>

            <!-- INCIDENT TYPE -->
            <div class="meta-item">
              <div class="meta-label">Classification</div>
              <div class="meta-value">${
                !incident.incident_type || incident.incident_type === "unknown"
                  ? "Processing classification..."
                  : formatIncidentType(incident.incident_type)
              }</div>
            </div>

            <!-- ADDRESS -->
            <div class="meta-item">
              <div class="meta-label">Address</div>
              <div class="meta-value">${
                incident.formatted_address
                  ? incident.formatted_address
                  : incident.address
                  ? incident.address + " (geocoding...)"
                  : "Processing address..."
              }</div>
            </div>

            <!-- COORDINATES -->
            <div class="meta-item">
              <div class="meta-label">Coordinates</div>
              <div class="meta-value">${
                incident.latitude && incident.longitude
                  ? `${incident.latitude.toFixed(
                      4
                    )}, ${incident.longitude.toFixed(4)}`
                  : "Processing location..."
              }</div>
            </div>

            <!-- PROPERTY OWNER -->
            <div class="meta-item">
              <div class="meta-label">Property Owner</div>
              <div class="meta-value">${
                incident.property_owner &&
                incident.property_owner !== null &&
                incident.property_owner !== "" &&
                incident.property_owner !== "null"
                  ? incident.property_owner
                  : incident.latitude && incident.longitude
                  ? "Processing property info..."
                  : "Pending location..."
              }</div>
            </div>

            <!-- PROPERTY VALUE -->
            <div class="meta-item">
              <div class="meta-label">Assessed Value</div>
              <div class="meta-value">${
                incident.property_price &&
                incident.property_price !== null &&
                incident.property_price !== 0
                  ? "$" + incident.property_price.toLocaleString()
                  : incident.latitude && incident.longitude
                  ? "Processing property info..."
                  : "Pending location..."
              }</div>
            </div>

            <!-- SYSTEM -->
            <div class="meta-item">
              <div class="meta-label">System</div>
              <div class="meta-value">${incident.system || "Unknown"}</div>
            </div>

            <!-- DEPARTMENT -->
            <div class="meta-item">
              <div class="meta-label">Department</div>
              <div class="meta-value">${incident.department || "Unknown"}</div>
            </div>

            <!-- CHANNEL -->
            <div class="meta-item">
              <div class="meta-label">Channel</div>
              <div class="meta-value">${incident.channel || "Unknown"}</div>
            </div>

            <!-- FREQUENCY -->
            <div class="meta-item">
              <div class="meta-label">Frequency</div>
              <div class="meta-value">${incident.frequency || "Unknown"}</div>
            </div>

            <!-- CONFIDENCE -->
            <div class="meta-item">
              <div class="meta-label">Confidence</div>
              <div class="meta-value">${confidencePercent}%</div>
            </div>
          </div>

          <!-- STREET VIEW - Only show when available, no fancy labels -->
          ${
            incident.streetview_url
              ? `
          <div class="incident-streetview">
            <div class="streetview-label">Street View</div>
            <div class="streetview-container">
              <img src="${incident.streetview_url}" 
                   alt="Street View" 
                   class="streetview-image" 
                   loading="lazy" 
                   onerror="this.parentElement.parentElement.style.display='none'"
                   onclick="window.open('${incident.streetview_url}', '_blank')">
            </div>
          </div>
        `
              : ""
          }

          <div class="incident-actions">
            <button class="action-btn play" onclick="playAudio('${
              incident.audio_filename || "no-audio"
            }', '${incident.system} - ${incident.department}', ${incident.id})"
                    ${
                      !incident.audio_filename ||
                      incident.audio_status === "missing"
                        ? 'title="Audio not available" style="opacity: 0.7;" disabled'
                        : ""
                    }>
              <i class="fas fa-play"></i>
              ${
                !incident.audio_filename || incident.audio_status === "missing"
                  ? "No Audio"
                  : "Play Audio"
              }
            </button>
            
            ${
              incident.formatted_address &&
              incident.formatted_address !== "Unknown" &&
              incident.formatted_address !== ""
                ? `
              <button class="action-btn" onclick="showOnMap(${incident.id})">
                <i class="fas fa-map-marker-alt"></i>
                Show on Map
              </button>
            `
                : ""
            }
            
            ${
              incident.maps_link
                ? `
              <a href="${incident.maps_link}" target="_blank" class="action-btn">
                <i class="fas fa-external-link-alt"></i>
                Google Maps
              </a>
            `
                : ""
            }
            
            <button class="action-btn analytics-btn" onclick="showAnalytics(${
              incident.id
            })">
              <i class="fas fa-chart-line"></i>
              Analytics
            </button>
          </div>
        `;

        // Add to feed
        liveFeed.appendChild(incidentEl);
      }

      // Sort incidents consistently by most recent time
      function sortIncidentsByTime(incidents) {
        return incidents.sort(
          (a, b) => new Date(b.time_recorded) - new Date(a.time_recorded)
        );
      }

      // Get count of currently visible incidents
      function getVisibleIncidentCount() {
        return document.querySelectorAll(".incident-card").length;
      }

      // Initialize Audio Player
      function initializeAudioPlayer() {
        audioPlayer = document.getElementById("audioPlayer");
        const audioElement = document.getElementById("audioElement");
        const playPauseBtn = document.getElementById("audioPlayPause");
        const closeBtn = document.getElementById("audioClose");

        playPauseBtn.addEventListener("click", function () {
          if (audioElement.paused) {
            audioElement.play();
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          } else {
            audioElement.pause();
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
          }
        });

        closeBtn.addEventListener("click", function () {
          audioElement.pause();
          audioPlayer.classList.remove("active");
          currentAudio = null;
        });

        audioElement.addEventListener("ended", function () {
          playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        });
      }

      // Load Initial Data (WebSocket only - no API calls)
      function loadInitialData() {
        loadStats(); // Only load stats via API (lightweight)
      }

      // Load Statistics
      function loadStats() {
        fetch("/api/stats")
          .then((response) => response.json())
          .then((data) => {
            updateStatsDisplay(data);
          })
          .catch((error) => {
            // Error loading stats - no action needed
          });
      }

      // Update stats display from data
      function updateStatsDisplay(data) {
        document.getElementById("totalToday").textContent =
          data.total_today || 0;
        document.getElementById("recentActivity").textContent =
          data.recent_activity || 0;
        document.getElementById("highPriorityPct").textContent =
          data.high_priority_percentage + "%" || "0%";
        document.getElementById("activeLocations").textContent =
          data.unique_locations || 0;
      }

      // Show notification to user
      function showNotification(message, type = "info") {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <div class="notification-content">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="float: right; background: none; border: none; color: white; cursor: pointer;">&times;</button>
          </div>
        `;

        // Add styles if not already added
        if (!document.getElementById("notification-styles")) {
          const styles = document.createElement("style");
          styles.id = "notification-styles";
          styles.innerHTML = `
            .notification {
              position: fixed;
              top: 20px;
              right: 20px;
              padding: 12px 20px;
              border-radius: 8px;
              color: white;
              z-index: 10000;
              animation: slideIn 0.3s ease-out;
              max-width: 350px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
              font-size: 0.875rem;
              transition: all 0.3s ease;
            }
            .notification-info { background: #3b82f6; }
            .notification-error { background: #ef4444; }
            .notification-success { background: #10b981; }
            .notification-warning { background: #f59e0b; }
            @keyframes slideIn {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
          `;
          document.head.appendChild(styles);
        }

        document.body.appendChild(notification);

        // Auto-remove after 3 seconds (reduced from 5)
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.opacity = "0";
            notification.style.transform = "translateX(100%)";
            setTimeout(() => notification.remove(), 300);
          }
        }, 3000);
      }

      // ===== REMOVED: loadIncidentFeed() and loadIncidentMap() =====
      // These functions have been removed for efficiency
      // All incident data now comes through WebSocket initial_data and new_incidents events
      // This eliminates redundant API calls and improves performance

      // Track processed incidents to avoid duplicates
      let processedIncidents = new Set();

      // Check if incident should be shown based on current filter
      function shouldShowIncident(incident) {
        if (currentFilter === "all") {
          return true;
        }
        return incident.incident_type === currentFilter;
      }

      // Add incident to feed (renamed from addLiveIncident)
      function addIncidentToFeed(incident, isNew = false) {
        // Check for duplicates
        if (processedIncidents.has(incident.id)) {
          return;
        }

        const liveFeed = document.getElementById("liveFeed");

        // Clear loading message if it exists
        if (liveFeed.querySelector(".loading")) {
          liveFeed.innerHTML = "";
        }

        const incidentEl = document.createElement("div");
        incidentEl.className = "incident-card";
        incidentEl.dataset.incidentId = incident.id;

        // Get incident type class
        const typeClass = getIncidentTypeClass(incident.incident_type);

        // Calculate confidence percentage
        const confidencePercent = Math.round((incident.confidence || 0) * 100);

        // Enhance transcript with callsign tooltips
        const enhancedTranscript = enhanceCallsigns(incident.transcript);

        incidentEl.innerHTML = `
          <div class="incident-header">
            <span class="incident-type-badge ${typeClass}">
              ${formatIncidentType(incident.incident_type)}
            </span>
            <span class="incident-time">${incident.time_recorded}</span>
          </div>

          <div class="incident-transcript">
            "${enhancedTranscript}"
          </div>

          ${
            incident.streetview_url
              ? `
          <div class="incident-streetview">
            <div class="streetview-label">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-street-view"></i>
                Street View - ${
                  incident.formatted_address || "incident location"
                }
              </div>
              <span class="streetview-hint">Click to open full size</span>
            </div>
            <div class="streetview-container">
              <img src="${incident.streetview_url}" alt="Street View of ${
                  incident.formatted_address || "incident location"
                }" 
                   class="streetview-image" loading="lazy" 
                   onerror="this.parentElement.parentElement.style.display='none'"
                   onclick="window.open('${
                     incident.streetview_url
                   }', '_blank')">
            </div>
          </div>
        `
              : ""
          }

          <div class="incident-meta">
            <div class="meta-item">
              <div class="meta-label">System</div>
              <div class="meta-value">${incident.system || "Unknown"}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Department</div>
              <div class="meta-value">${incident.department || "Unknown"}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Channel</div>
              <div class="meta-value">${incident.channel || "Unknown"}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Frequency</div>
              <div class="meta-value">${incident.frequency || "Unknown"}</div>
            </div>
            ${
              incident.formatted_address
                ? `
            <div class="meta-item">
              <div class="meta-label">Location</div>
              <div class="meta-value">${incident.formatted_address}</div>
            </div>
            `
                : ""
            }
            ${
              incident.property_owner &&
              incident.property_owner !== null &&
              incident.property_owner !== "" &&
              incident.property_owner !== "null"
                ? `
            <div class="meta-item">
              <div class="meta-label">Property Owner</div>
              <div class="meta-value">
                <i class="fas fa-user" style="margin-right: 0.5rem; color: #64B5F6;"></i>
                ${incident.property_owner}
              </div>
            </div>
            `
                : ""
            }
            ${
              incident.property_price &&
              incident.property_price !== null &&
              incident.property_price !== 0
                ? `
            <div class="meta-item">
              <div class="meta-label">Assessed Value</div>
              <div class="meta-value">
                <i class="fas fa-dollar-sign" style="margin-right: 0.5rem; color: #81C784;"></i>
                $${incident.property_price.toLocaleString()}
              </div>
            </div>
            `
                : ""
            }
            <div class="meta-item">
              <div class="meta-label">Confidence</div>
              <div class="meta-value">
                <div class="confidence-meter">
                  <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                  </div>
                  <span class="confidence-text">${confidencePercent}%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="incident-actions">
            <!-- ALWAYS show audio button for every incident -->
            <button class="action-btn play" onclick="playAudio('${
              incident.audio_filename || "no-audio"
            }', '${incident.system} - ${incident.department}', ${incident.id})"
                    ${
                      !incident.audio_filename ||
                      incident.audio_status === "missing"
                        ? 'title="Audio not available" style="opacity: 0.7;" disabled'
                        : ""
                    }>
              <i class="fas fa-play"></i>
              ${
                !incident.audio_filename || incident.audio_status === "missing"
                  ? "No Audio"
                  : "Play Audio"
              }
            </button>
            
            <!-- ONLY show "Show on Map" button for incidents with actual locations -->
            ${
              incident.formatted_address &&
              incident.formatted_address !== "Unknown" &&
              incident.formatted_address !== ""
                ? `
              <button class="action-btn" onclick="showOnMap(${incident.id})" title="Highlight this incident on map">
                <i class="fas fa-map-marker-alt"></i>
                Show on Map
              </button>
            `
                : ""
            }
            
            ${
              incident.maps_link
                ? `
              <a href="${incident.maps_link}" target="_blank" class="action-btn">
                <i class="fas fa-external-link-alt"></i>
                Google Maps
              </a>
            `
                : ""
            }
            
            <button class="action-btn analytics-btn" onclick="showAnalytics(${
              incident.id
            })" title="View detailed analytics and metadata">
              <i class="fas fa-chart-line"></i>
              Analytics
            </button>
          </div>
        `;

        // Add to top of feed with animation
        // Smart insertion to maintain strict chronological order
        if (isNew) {
          // For new incidents, find the correct position to maintain ID order
          const existingCards = Array.from(
            liveFeed.querySelectorAll(".incident-card")
          );
          let insertPosition = null;

          // Find the correct position (incidents are ordered newest to oldest)
          for (let card of existingCards) {
            const cardId = parseInt(card.dataset.incidentId);
            if (incident.id > cardId) {
              insertPosition = card;
              break;
            }
          }

          // Insert with animation
          incidentEl.style.transform = "translateX(-100%)";
          incidentEl.style.opacity = "0";

          if (insertPosition) {
            liveFeed.insertBefore(incidentEl, insertPosition);
          } else {
            liveFeed.appendChild(incidentEl); // Insert at end if it's the oldest
          }

          // Animate in
          setTimeout(() => {
            incidentEl.style.transform = "translateX(0)";
            incidentEl.style.opacity = "1";
          }, 100);
        } else {
          // For initial load, append in ID order (oldest to newest, then display newest first)
          liveFeed.appendChild(incidentEl);
        }
      }

      // Clear all map markers
      function clearMapMarkers() {
        if (window.incidentMarkers) {
          window.incidentMarkers.forEach((marker) =>
            incidentMap.removeLayer(marker)
          );
        }
        window.incidentMarkers = [];
        mapCounter = 0;
      }

      // Update Map with Incidents (with rate limiting)
      function updateMapWithIncidents(incidents) {
        // Store incidents globally for color mode switching
        window.allIncidents = incidents;

        // Clear existing markers
        if (window.incidentMarkers) {
          window.incidentMarkers.forEach((marker) =>
            incidentMap.removeLayer(marker)
          );
        }
        window.incidentMarkers = [];
        mapCounter = 0;

        // Filter incidents with addresses
        const incidentsWithAddresses = incidents.filter(
          (incident) =>
            incident.formatted_address &&
            incident.formatted_address !== "Unknown" &&
            incident.formatted_address !== ""
        );

        // Process with delay to avoid rate limiting
        let delay = 0;
        incidentsWithAddresses.forEach((incident, index) => {
          setTimeout(() => {
            addIncidentToMap(incident);
          }, delay);
          delay += 200; // 200ms delay between geocoding requests
        });

        updateMapCounter();
        updateMapLegend();
      }

      // Add markers to map without clearing existing ones (used for color mode switching)
      function addMarkersToMap(incidents) {
        console.log(
          "addMarkersToMap called with",
          incidents.length,
          "incidents"
        );

        // Filter incidents with addresses
        const incidentsWithAddresses = incidents.filter(
          (incident) =>
            incident.formatted_address &&
            incident.formatted_address !== "Unknown" &&
            incident.formatted_address !== ""
        );

        console.log(
          "Filtered to",
          incidentsWithAddresses.length,
          "incidents with addresses"
        );

        // Add markers immediately without delay (since we're just changing colors)
        incidentsWithAddresses.forEach((incident, index) => {
          addIncidentToMap(incident);
        });

        updateMapCounter();
      }

      // Add Incident to Map using REAL coordinates from database
      function addIncidentToMap(incident) {
        // PREVENT DUPLICATES: Check if marker already exists for this incident
        if (window.incidentMarkers) {
          const existingMarker = window.incidentMarkers.find(
            (m) => m.incidentId === incident.id
          );
          if (existingMarker) {
            console.log("Skipping duplicate marker for incident", incident.id);
            return;
          }
        }

        // Check if we have real coordinates from the enhanced geocoding
        if (incident.latitude && incident.longitude) {
          const lat = parseFloat(incident.latitude);
          const lng = parseFloat(incident.longitude);

          // Use coordinates if they're valid numbers
          if (!isNaN(lat) && !isNaN(lng)) {
            createIncidentMarker(incident, lat, lng);
            return;
          }
        }

        // Skip incidents without coordinates or addresses
        if (
          !incident.formatted_address ||
          incident.formatted_address === "Unknown" ||
          incident.formatted_address === ""
        ) {
          return;
        }
      }

      // Update existing marker on map when incident data changes
      function updateIncidentMarker(incident) {
        if (!window.incidentMarkers) return;

        // Find existing marker
        const existingMarkerIndex = window.incidentMarkers.findIndex(
          (m) => m.incidentId === incident.id
        );

        if (existingMarkerIndex !== -1) {
          // Remove old marker from map
          const oldMarker = window.incidentMarkers[existingMarkerIndex];
          if (oldMarker.marker && window.map) {
            window.map.removeLayer(oldMarker.marker);
          }

          // Remove from array
          window.incidentMarkers.splice(existingMarkerIndex, 1);
        }

        // Add updated marker (if it has coordinates)
        if (incident.latitude && incident.longitude) {
          const lat = parseFloat(incident.latitude);
          const lng = parseFloat(incident.longitude);

          if (!isNaN(lat) && !isNaN(lng)) {
            createIncidentMarker(incident, lat, lng);
          }
        }
      }

      // Static geocoding coordinates for Newton, MA areas (fallback when API unavailable)
      const staticLocations = {
        newton: { lat: 42.337, lng: -71.2092 },
        "newton centre": { lat: 42.3256, lng: -71.1922 },
        "newton center": { lat: 42.3256, lng: -71.1922 },
        "newton highlands": { lat: 42.322, lng: -71.2061 },
        newtonville: { lat: 42.3529, lng: -71.2061 },
        "west newton": { lat: 42.3548, lng: -71.229 },
        auburndale: { lat: 42.3465, lng: -71.2495 },
        "chestnut hill": { lat: 42.3251, lng: -71.1656 },
        "newton upper falls": { lat: 42.3017, lng: -71.2528 },
        waltham: { lat: 42.3765, lng: -71.2356 },
        brookline: { lat: 42.3317, lng: -71.1212 },
        "ma-9": { lat: 42.337, lng: -71.2092 }, // Route 9 through Newton
        "route 9": { lat: 42.337, lng: -71.2092 },
      };

      // Fallback geocoding using static coordinates
      function geocodeFallback(incident) {
        // Extract location key from formatted address
        let locationKey = "newton"; // Default
        const address = incident.formatted_address.toLowerCase();

        // Check for specific Newton areas
        for (const [key, coords] of Object.entries(staticLocations)) {
          if (address.includes(key)) {
            locationKey = key;
            break;
          }
        }

        const coords = staticLocations[locationKey];

        // Add small random offset to avoid overlapping markers (±0.002 degrees ≈ ±200m)
        const lat = coords.lat + (Math.random() - 0.5) * 0.004;
        const lng = coords.lng + (Math.random() - 0.5) * 0.004;

        createIncidentMarker(incident, lat, lng);
      }

      // Current color mode (default: incident-type)
      let currentColorMode = "incident-type";

      // Change color mode and refresh map
      function changeColorMode() {
        console.log("changeColorMode called");
        const select = document.getElementById("colorMode");
        currentColorMode = select.value;
        console.log("New color mode:", currentColorMode);

        // Check if map is initialized
        if (!incidentMap) {
          console.error("incidentMap is not initialized yet");
          return;
        }

        // Update legend first
        updateMapLegend();

        // Refresh all markers with new color scheme
        refreshMapColors();
      }

      // Refresh all markers with current color mode
      function refreshMapColors() {
        console.log("refreshMapColors called");
        console.log("incidentMap available:", !!incidentMap);
        console.log("window.incidentMarkers:", window.incidentMarkers);
        console.log("window.allIncidents available:", !!window.allIncidents);
        if (window.allIncidents) {
          console.log(
            "window.allIncidents length:",
            window.allIncidents.length
          );
          console.log("First incident sample:", window.allIncidents[0]);
        }

        // Clear existing markers
        if (window.incidentMarkers) {
          console.log("Clearing", window.incidentMarkers.length, "markers");
          window.incidentMarkers.forEach((marker) => {
            if (incidentMap && typeof incidentMap.removeLayer === "function") {
              incidentMap.removeLayer(marker);
            } else {
              console.error(
                "incidentMap not available or removeLayer not a function"
              );
            }
          });
          window.incidentMarkers = [];
        }

        // Re-add all markers with new styling
        console.log(
          "window.allIncidents:",
          window.allIncidents ? window.allIncidents.length : "undefined"
        );
        if (window.allIncidents && window.allIncidents.length > 0) {
          console.log(
            "Calling addMarkersToMap with",
            window.allIncidents.length,
            "incidents"
          );
          addMarkersToMap(window.allIncidents);
        } else {
          console.error(
            "No incidents to display or window.allIncidents is undefined"
          );
        }
      }

      // Get incident severity level (High, Medium, Low)
      function getIncidentSeverity(incidentType) {
        const highSeverity = [
          "Weapons/Shots Fired",
          "Structure Fire",
          "Assault/Domestic",
          "Medical",
          "Motor Vehicle Accident",
          "Hazmat",
          "Emergency Medical",
          "Fire Response",
          "medical_emergency",
          "fire_emergency",
          "domestic_disturbance",
        ];

        const mediumSeverity = [
          "Alarm (Burglar/Panic)",
          "Fire Alarm",
          "Brush/Vehicle Fire",
          "Gas/Electrical Hazard",
          "Theft/Burglary",
          "Missing Person",
          "Police Response",
          "Public Safety",
          "police_operation",
          "suspicious_activity",
          "alarm_activation",
          "traffic_violation",
        ];

        // Check for high severity first
        if (
          highSeverity.some((type) =>
            incidentType.toLowerCase().includes(type.toLowerCase())
          )
        ) {
          return "high";
        }

        // Check for medium severity
        if (
          mediumSeverity.some((type) =>
            incidentType.toLowerCase().includes(type.toLowerCase())
          )
        ) {
          return "medium";
        }

        // Default to low severity
        return "low";
      }

      // Get time elapsed in hours
      function getTimeElapsed(timeRecorded) {
        console.log("Parsing time:", timeRecorded);

        // Parse HH:MM:SS format (24-hour time)
        const timeMatch = timeRecorded.match(/^(\d{1,2}):(\d{2}):(\d{2})$/);
        if (!timeMatch) {
          console.error(
            "Invalid time format. Expected HH:MM:SS, got:",
            timeRecorded
          );
          return 0;
        }

        const [, hours, minutes, seconds] = timeMatch;
        const incidentHour = parseInt(hours);
        const incidentMinute = parseInt(minutes);
        const incidentSecond = parseInt(seconds);

        // Get current time
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentSecond = now.getSeconds();

        // Calculate today's incident time
        const today = new Date();
        today.setHours(incidentHour, incidentMinute, incidentSecond, 0);

        // Calculate time difference
        const diffMs = now - today;
        const diffHours = diffMs / (1000 * 60 * 60);

        console.log(
          "  Incident time:",
          `${incidentHour}:${incidentMinute}:${incidentSecond}`
        );
        console.log(
          "  Current time:",
          `${currentHour}:${currentMinute}:${currentSecond}`
        );
        console.log("  Hours elapsed:", diffHours.toFixed(2));

        // Handle case where incident is "tomorrow" (negative diff means future time today)
        if (diffHours < 0) {
          // Assume it's from yesterday
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const diffYesterday = (now - yesterday) / (1000 * 60 * 60);
          console.log(
            "  Assuming yesterday, hours elapsed:",
            diffYesterday.toFixed(2)
          );
          return diffYesterday;
        }

        return diffHours;
      }

      // Function to update map legend based on current color mode
      function updateMapLegend() {
        const titleElement = document.getElementById("legend-title");
        const contentElement = document.getElementById("legend-content");

        if (!titleElement || !contentElement) return;

        let legendContent = "";

        if (currentColorMode === "incident-type") {
          titleElement.innerHTML = "📍 Incident Categories";
          legendContent = `
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #dc2626;"></div>
              <span style="color: #cbd5e1">Medical Emergency</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #ea580c;"></div>
              <span style="color: #cbd5e1">Fire Emergency</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #dc2626;"></div>
              <span style="color: #cbd5e1">Vehicle Accident</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #2563eb;"></div>
              <span style="color: #cbd5e1">Police Operation</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #7c3aed;"></div>
              <span style="color: #cbd5e1">Suspicious Activity</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #d97706;"></div>
              <span style="color: #cbd5e1">Traffic Violation</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #dc2626;"></div>
              <span style="color: #cbd5e1">Domestic Issue</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #d97706;"></div>
              <span style="color: #cbd5e1">Alarm</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #7c2d12;"></div>
              <span style="color: #cbd5e1">Theft/Burglary</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #0891b2;"></div>
              <span style="color: #cbd5e1">Welfare Check</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #16a34a;"></div>
              <span style="color: #cbd5e1">Found Property</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #64748b;"></div>
              <span style="color: #cbd5e1">Unknown</span>
            </div>
          `;
        } else if (currentColorMode === "severity") {
          titleElement.innerHTML = "🚨 Severity Levels";
          legendContent = `
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 14px; height: 14px; border-radius: 50%; background: #dc2626; opacity: 0.9;"></div>
              <span style="color: #cbd5e1; font-weight: 600;">High Priority</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b; opacity: 0.8;"></div>
              <span style="color: #cbd5e1">Medium Priority</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: #10b981; opacity: 0.7;"></div>
              <span style="color: #cbd5e1">Low Priority</span>
            </div>
          `;
        } else if (currentColorMode === "time-elapsed") {
          titleElement.innerHTML = "⏱️ Time Elapsed";
          legendContent = `
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444; opacity: 0.9;"></div>
              <span style="color: #cbd5e1; font-weight: 600;">Very Recent (0-30 min)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 7px; height: 7px; border-radius: 50%; background: #f97316; opacity: 0.8;"></div>
              <span style="color: #cbd5e1">Recent (30min-2hr)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 6px; height: 6px; border-radius: 50%; background: #f59e0b; opacity: 0.7;"></div>
              <span style="color: #cbd5e1">Older (2hr-6hr)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 3px">
              <div style="width: 5px; height: 5px; border-radius: 50%; background: #64748b; opacity: 0.6;"></div>
              <span style="color: #cbd5e1">Stale (6hr+)</span>
            </div>
          `;
        }

        contentElement.innerHTML = legendContent;
      }

      // Get color and size based on current mode
      function getMarkerStyle(incident) {
        let color, radius, opacity;

        switch (currentColorMode) {
          case "severity":
            const severity = getIncidentSeverity(incident.incident_type);
            switch (severity) {
              case "high":
                color = "#dc2626"; // Red - High Priority
                radius = 10;
                opacity = 0.9;
                break;
              case "medium":
                color = "#f59e0b"; // Amber - Medium Priority
                radius = 8;
                opacity = 0.8;
                break;
              case "low":
                color = "#10b981"; // Green - Low Priority
                radius = 6;
                opacity = 0.7;
                break;
            }
            break;

          case "time-elapsed":
            const hoursElapsed = getTimeElapsed(incident.time_recorded);
            console.log(
              "Time-elapsed mode - incident",
              incident.id,
              "hours elapsed:",
              hoursElapsed
            );

            if (hoursElapsed <= 0.5) {
              // Very recent (0-30 minutes) - Bright red, large
              color = "#ef4444";
              radius = 12;
              opacity = 0.9;
              console.log("  -> Very recent (0-30min)");
            } else if (hoursElapsed <= 2) {
              // Recent (30min-2hr) - Orange, small
              color = "#f97316";
              radius = 7;
              opacity = 0.8;
              console.log("  -> Recent (30min-2hr)");
            } else if (hoursElapsed <= 6) {
              // Older (2hr-6hr) - Yellow, smaller
              color = "#f59e0b";
              radius = 6;
              opacity = 0.7;
              console.log("  -> Older (2hr-6hr)");
            } else {
              // Stale (6hr+) - Gray, smallest
              color = "#64748b";
              radius = 5;
              opacity = 0.6;
              console.log("  -> Stale (6hr+)");
            }
            break;

          case "incident-type":
          default:
            color = getIncidentColor(incident.incident_type);
            radius = 8;
            opacity = 0.8;
            break;
        }

        return { color, radius, opacity };
      }

      // Professional Color System Based on Actual Incident Types
      function getIncidentColor(incidentType) {
        // Color mapping based on actual incident types found in the database
        const colors = {
          // High Priority Emergency - Red
          medical_emergency: "#dc2626",
          fire_emergency: "#ea580c",
          motor_vehicle_accident: "#dc2626",
          domestic_disturbance: "#dc2626",

          // Police Operations - Blue shades
          police_operation: "#2563eb",
          suspicious_activity: "#7c3aed",
          welfare_check: "#0891b2",

          // Traffic/Public Safety - Orange/Amber
          traffic_violation: "#d97706",
          alarm_activation: "#d97706",

          // Property/Theft - Brown
          theft_burglary: "#7c2d12",

          // Other/Non-emergency - Green/Gray
          found_property: "#16a34a",

          // Legacy mappings for backwards compatibility
          "Assault/Domestic": "#dc2626",
          "Weapons/Shots Fired": "#991b1b",
          "Motor Vehicle Accident": "#dc2626",
          Medical: "#dc2626",
          "Structure Fire": "#dc2626",
          "Alarm (Burglar/Panic)": "#dc2626",
          "Fire Alarm": "#ea580c",
          "Brush/Vehicle Fire": "#ea580c",
          "Gas/Electrical Hazard": "#d97706",
          "Wires Down": "#ca8a04",
          "Disturbance/Noise": "#d97706",
          "Traffic Stop": "#2563eb",
          "Welfare Check": "#0891b2",
          "Suspicious Activity": "#7c3aed",
          "Missing Person": "#be185d",
          "Theft/Burglary": "#7c2d12",
          Hazmat: "#7c2d12",
          "Animal Complaint": "#16a34a",

          // Fallback
          unknown: "#64748b",
          other: "#64748b",
        };

        // Return color based on exact type match, with fallback to gray
        return colors[incidentType] || colors["unknown"];
      }

      // Create marker with proper styling
      function createIncidentMarker(incident, lat, lng) {
        console.log(
          "createIncidentMarker called for incident",
          incident.id,
          "at",
          lat,
          lng
        );
        if (!incidentMap) {
          console.error("incidentMap not available");
          return;
        }

        const typeClass = getIncidentTypeClass(incident.incident_type);

        // Get dynamic styling based on current color mode
        const markerStyle = getMarkerStyle(incident);
        console.log("Marker style:", markerStyle);

        try {
          const marker = L.circleMarker([lat, lng], {
            radius: markerStyle.radius,
            fillColor: markerStyle.color,
            color: "#ffffff",
            weight: 2,
            opacity: markerStyle.opacity,
            fillOpacity: markerStyle.opacity * 0.8,
          }).addTo(incidentMap);

          const popupContent = `
          <div style="min-width: 280px; max-width: 320px;">
            <div style="margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
              <span style="background: ${
                markerStyle.color
              }; color: white; padding: 4px 12px; border-radius: 16px; font-size: 0.75rem; font-weight: 600;">
                ${formatIncidentType(incident.incident_type)}
              </span>
              <span style="color: #64748b; font-size: 0.875rem; font-weight: 500;">
                ${incident.time_recorded}
              </span>
            </div>
            <div style="margin-bottom: 12px; font-weight: 600; color: #1e293b;">
              📡 ${incident.system} - ${incident.department}
            </div>
            <div style="margin-bottom: 12px; font-style: italic; color: #334155; background: #f1f5f9; padding: 8px; border-radius: 8px; border-left: 3px solid ${
              markerStyle.color
            };">
              "${incident.transcript}"
            </div>
            <div style="margin-bottom: 8px; font-size: 0.875rem; color: #475569;">
              📍 ${incident.formatted_address || "Location unknown"}
            </div>
            <div style="margin-bottom: 12px; font-size: 0.875rem; color: #64748b;">
              📻 ${incident.frequency} • ${incident.channel}
            </div>
            <!-- Audio playback and navigation -->
            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="playAudio('${
                incident.audio_filename || "no-audio"
              }', '${incident.system} - ${incident.department}', ${
            incident.id
          })" 
                      style="background: ${
                        !incident.audio_filename ? "#6b7280" : "#059669"
                      }; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.875rem; cursor: pointer; font-weight: 600;"
                      ${
                        !incident.audio_filename
                          ? 'title="Audio not available" disabled'
                          : ""
                      }>
                <i class="fas fa-play"></i> ${
                  !incident.audio_filename ? "No Audio" : "Play Audio"
                }
              </button>
              
              <button onclick="jumpToIncident(${incident.id})" 
                      style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.875rem; cursor: pointer; font-weight: 600;">
                <i class="fas fa-comments"></i> Jump to Chat
              </button>
            </div>
          </div>
        `;

          marker.bindPopup(popupContent);
          marker.incidentId = incident.id;
          window.incidentMarkers.push(marker);
          mapCounter++;
          console.log(
            "Successfully created marker for incident",
            incident.id,
            "Total markers:",
            window.incidentMarkers.length
          );
        } catch (error) {
          console.error(
            "Error creating marker for incident",
            incident.id,
            ":",
            error
          );
        }
      }

      // Helper function to create incident card HTML
      function createIncidentCard(incident) {
        const typeClass = getIncidentTypeClass(incident.incident_type);
        const confidencePercent = Math.round((incident.confidence || 0) * 100);
        const enhancedTranscript = enhanceCallsigns(incident.transcript);

        return `
          <div class="incident-card" data-incident-id="${incident.id}">
            <div class="incident-header">
              <span class="incident-type-badge ${typeClass}">
                ${formatIncidentType(incident.incident_type)}
              </span>
              <span class="incident-time">${incident.time_recorded}</span>
            </div>

            <div class="incident-transcript">
              "${enhancedTranscript}"
            </div>

            ${
              incident.streetview_url
                ? `
            <div class="incident-streetview">
              <div class="streetview-label">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-street-view"></i>
                  Street View - ${
                    incident.formatted_address || "incident location"
                  }
                </div>
                <span class="streetview-hint">Click to open full size</span>
              </div>
              <div class="streetview-container">
                <img src="${incident.streetview_url}" alt="Street View of ${
                    incident.formatted_address || "incident location"
                  }" 
                     class="streetview-image" loading="lazy" 
                     onerror="this.parentElement.parentElement.style.display='none'"
                     onclick="window.open('${
                       incident.streetview_url
                     }', '_blank')">
              </div>
            </div>
          `
                : ""
            }

            <div class="incident-meta">
              <div class="meta-item">
                <div class="meta-label">System</div>
                <div class="meta-value">${incident.system || "Unknown"}</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Department</div>
                <div class="meta-value">${
                  incident.department || "Unknown"
                }</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Channel</div>
                <div class="meta-value">${incident.channel || "Unknown"}</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Frequency</div>
                <div class="meta-value">${incident.frequency || "Unknown"}</div>
              </div>
              ${
                incident.formatted_address
                  ? `
              <div class="meta-item">
                <div class="meta-label">Location</div>
                <div class="meta-value">${incident.formatted_address}</div>
              </div>
              `
                  : ""
              }
              ${
                incident.property_owner &&
                incident.property_owner !== null &&
                incident.property_owner !== "" &&
                incident.property_owner !== "null"
                  ? `
              <div class="meta-item">
                <div class="meta-label">Property Owner</div>
                <div class="meta-value">
                  <i class="fas fa-user" style="margin-right: 0.5rem; color: #64B5F6;"></i>
                  ${incident.property_owner}
                </div>
              </div>
              `
                  : ""
              }
              ${
                incident.property_price &&
                incident.property_price !== null &&
                incident.property_price !== 0
                  ? `
              <div class="meta-item">
                <div class="meta-label">Assessed Value</div>
                <div class="meta-value">
                  <i class="fas fa-dollar-sign" style="margin-right: 0.5rem; color: #81C784;"></i>
                  $${incident.property_price.toLocaleString()}
                </div>
              </div>
              `
                  : ""
              }
              <div class="meta-item">
                <div class="meta-label">Confidence</div>
                <div class="meta-value">
                  <div class="confidence-meter">
                    <div class="confidence-bar">
                      <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                    </div>
                    <span class="confidence-text">${confidencePercent}%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="incident-actions">
              <button class="action-btn play" onclick="playAudio('${
                incident.audio_filename || "no-audio"
              }', '${incident.system} - ${incident.department}', ${
          incident.id
        })"
                      ${
                        !incident.audio_filename ||
                        incident.audio_status === "missing"
                          ? 'title="Audio not available" style="opacity: 0.7;" disabled'
                          : ""
                      }>
                <i class="fas fa-play"></i>
                ${
                  !incident.audio_filename ||
                  incident.audio_status === "missing"
                    ? "No Audio"
                    : "Play Audio"
                }
              </button>
              
              ${
                incident.formatted_address &&
                incident.formatted_address !== "Unknown" &&
                incident.formatted_address !== ""
                  ? `
                <button class="action-btn" onclick="showOnMap(${incident.id})" title="Highlight this incident on map">
                  <i class="fas fa-map-marker-alt"></i>
                  Show on Map
                </button>
              `
                  : ""
              }
              
              ${
                incident.maps_link
                  ? `
                <a href="${incident.maps_link}" target="_blank" class="action-btn">
                  <i class="fas fa-external-link-alt"></i>
                  Google Maps
                </a>
              `
                  : ""
              }
              
              <button class="action-btn analytics-btn" onclick="showAnalytics(${
                incident.id
              })" title="View detailed analytics and metadata">
                <i class="fas fa-chart-line"></i>
                Analytics
              </button>
            </div>
          </div>
        `;
      }

      // Helper Functions
      function getIncidentTypeClass(type) {
        if (!type) return "type-other";
        // Convert incident type to CSS class
        return `type-${type.toLowerCase().replace(/[^a-z0-9]/g, "_")}`;
      }

      function formatIncidentType(type) {
        // Simple static text - NO animations, NO emojis
        if (!type || type === "" || type === null) return "Processing...";
        if (type === "unknown") return "Radio Communication";

        // Format incident type for display
        return type
          .replace(/_/g, " ")
          .replace(/\//g, " / ")
          .replace(/\b\w/g, (l) => l.toUpperCase());
      }

      function getMarkerColor(type) {
        const colors = {
          fire_emergency: "#dc2626",
          medical_emergency: "#dc2626",
          traffic_violation: "#d97706",
          police_response: "#0891b2",
          public_safety: "#7c3aed",
          other: "#64748b",
        };
        return colors[type] || colors["other"];
      }

      function updateConnectionStatus(connected) {
        const status = document.getElementById("connectionStatus");
        if (connected) {
          status.className = "connection-status connected";
          status.innerHTML = '<i class="fas fa-satellite-dish"></i> Live';
        } else {
          status.className = "connection-status disconnected";
          status.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Reconnecting...';
        }
      }

      function updateFeedCounter(count) {
        document.getElementById(
          "feedCounter"
        ).textContent = `${count} incidents`;
      }

      function updateMapCounter() {
        document.getElementById(
          "mapCounter"
        ).textContent = `${mapCounter} incidents plotted`;
      }

      function checkConnection() {
        if (socket && socket.connected) {
          updateConnectionStatus(true);
        } else {
          updateConnectionStatus(false);
        }
      }

      // Audio Functions
      function playAudio(filename, title, incidentId) {
        if (!filename || filename === "no-audio") {
          alert("Audio not available for this incident");
          return;
        }

        const audioElement = document.getElementById("audioElement");
        const audioInfo = document.getElementById("audioInfo");
        const playPauseBtn = document.getElementById("audioPlayPause");

        // CRITICAL FIX: Include incident ID to get the correct audio file
        const audioUrl = incidentId
          ? `/audio/${filename}?incident_id=${incidentId}`
          : `/audio/${filename}`;
        console.log("🎵 Attempting to play audio:", audioUrl);

        audioElement.src = audioUrl;
        audioInfo.textContent = title;
        audioPlayer.classList.add("active");

        audioElement
          .play()
          .then(() => {
            console.log("✅ Audio playback started successfully");
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            currentAudio = filename;
          })
          .catch((error) => {
            console.error("❌ Audio playback failed:", error);
            console.error("Failed URL:", audioUrl);
            audioInfo.textContent = `Audio playback failed: ${error.message}`;
            alert(`Audio playback failed: ${error.message}`);
          });
      }

      function focusOnMap(incidentId) {
        const marker = incidentMarkers.find((m) => m.incidentId === incidentId);
        if (marker) {
          incidentMap.setView(marker.getLatLng(), 15);
          marker.openPopup();
        }
      }

      // Bidirectional Navigation Functions
      function showOnMap(incidentId) {
        // Find the map marker for this incident
        const marker = incidentMarkers.find((m) => m.incidentId === incidentId);
        if (marker) {
          // Center map on marker and open popup
          incidentMap.setView(marker.getLatLng(), 16);
          marker.openPopup();

          // Add temporary highlight effect
          const originalColor = marker.options.fillColor;
          marker.setStyle({
            fillColor: "#ffff00", // Bright yellow highlight
            color: "#ffff00",
            weight: 4,
          });

          // Reset color after 2 seconds
          setTimeout(() => {
            marker.setStyle({
              fillColor: originalColor,
              color: originalColor,
              weight: 2,
            });
          }, 2000);
        }
      }

      function jumpToIncident(incidentId) {
        // Find the incident element in the feed
        const incidentElement = document.querySelector(
          `[data-incident-id="${incidentId}"]`
        );
        if (incidentElement) {
          // Scroll to the incident in the feed
          incidentElement.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });

          // Add temporary highlight effect
          const originalBackground = incidentElement.style.backgroundColor;
          incidentElement.style.backgroundColor = "rgba(59, 130, 246, 0.15)"; // Clean blue highlight that matches the dashboard theme
          incidentElement.style.border = "2px solid var(--accent-blue)";
          incidentElement.style.transform = "scale(1.02)";
          incidentElement.style.transformOrigin = "center center";
          incidentElement.style.transition = "all 0.3s ease";
          incidentElement.style.boxShadow =
            "0 4px 20px rgba(59, 130, 246, 0.3)";

          // Reset styling after 2 seconds
          setTimeout(() => {
            incidentElement.style.backgroundColor = originalBackground;
            incidentElement.style.border = "";
            incidentElement.style.transform = "scale(1)";
            incidentElement.style.transformOrigin = "";
            incidentElement.style.boxShadow = "";
          }, 2000);
        }
      }

      // Auto-refresh stats only (reduced frequency for stability)
      setInterval(() => {
        if (socket && socket.connected) {
          loadStats();
        }
      }, 60000); // Every 60 seconds instead of 30

      // Address Filter Functionality

      // Initialize address filter panel
      function initializeAddressFilter() {
        const addressFilterToggle = document.getElementById(
          "addressFilterToggle"
        );
        const addressFilterContent = document.getElementById(
          "addressFilterContent"
        );
        const addressFilterButtons = document.querySelectorAll(
          "[data-address-filter]"
        );

        if (!addressFilterToggle || !addressFilterContent) {
          console.log("Address filter elements not found");
          return;
        }

        // Ensure address filter panel starts expanded
        addressFilterContent.classList.remove("collapsed");
        addressFilterToggle.classList.remove("collapsed");

        // Toggle address filter panel
        addressFilterToggle.addEventListener("click", () => {
          addressFilterContent.classList.toggle("collapsed");
          addressFilterToggle.classList.toggle("collapsed");
        });

        // Address filter button handlers
        addressFilterButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            e.preventDefault();

            // Remove active class from all address filter buttons
            addressFilterButtons.forEach((btn) =>
              btn.classList.remove("active")
            );

            // Add active class to clicked button
            button.classList.add("active");

            // Update current address filter
            currentAddressFilter = button.dataset.addressFilter;

            // Update counters and re-apply current incident type filter
            updateAddressCounters();
            filterByType(currentFilter);
          });
        });

        // Initialize counters
        updateAddressCounters();
        console.log("Address filter initialized");
      }

      // Update address filter counters
      function updateAddressCounters() {
        if (!allIncidents || allIncidents.length === 0) {
          updateAddressFilterDisplay(0, 0, 0);
          return;
        }

        let withAddressCount = 0;
        let noAddressCount = 0;
        let totalCount = allIncidents.length;

        allIncidents.forEach((incident) => {
          const hasValidAddress =
            incident.formatted_address &&
            incident.formatted_address !== "Unknown" &&
            incident.formatted_address.trim() !== "" &&
            incident.formatted_address !== "Newton, MA, USA";

          if (hasValidAddress) {
            withAddressCount++;
          } else {
            noAddressCount++;
          }
        });

        updateAddressFilterDisplay(
          totalCount,
          withAddressCount,
          noAddressCount
        );
      }

      // Update address filter display counters
      function updateAddressFilterDisplay(total, withAddress, noAddress) {
        const totalEl = document.getElementById("totalAddressCount");
        const withEl = document.getElementById("withAddressCount");
        const noEl = document.getElementById("noAddressCount");

        if (totalEl) totalEl.textContent = total;
        if (withEl) withEl.textContent = withAddress;
        if (noEl) noEl.textContent = noAddress;
      }

      // Callsign Modal Functions
      function openCallsignModal() {
        document.getElementById("callsignModal").classList.add("active");
        document.body.style.overflow = "hidden"; // Prevent background scrolling
      }

      function closeCallsignModal() {
        document.getElementById("callsignModal").classList.remove("active");
        document.body.style.overflow = ""; // Restore scrolling
      }

      // Analytics Modal Functions
      function showAnalytics(incidentId) {
        console.log("🔍 Analytics button clicked for incident:", incidentId);
        const incident = allIncidents.find((inc) => inc.id === incidentId);
        if (!incident) {
          console.error("❌ Incident not found:", incidentId);
          console.log(
            "Available incidents:",
            allIncidents.map((i) => i.id)
          );
          return;
        }

        console.log("✅ Found incident:", incident);
        const modal = document.getElementById("analyticsModal");
        const content = document.getElementById("analyticsModalContent");

        if (!modal) {
          console.error("❌ Analytics modal element not found!");
          return;
        }

        if (!content) {
          console.error("❌ Analytics modal content element not found!");
          return;
        }

        // Build analytics content
        console.log("📊 Generating analytics content...");
        content.innerHTML = generateAnalyticsContent(incident);

        // Show modal
        console.log("✅ Showing analytics modal");
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeAnalyticsModal() {
        console.log("🔒 Closing analytics modal");
        document.getElementById("analyticsModal").classList.remove("active");
        document.body.style.overflow = "";
      }

      function generateAnalyticsContent(incident) {
        const confidencePercent = Math.round((incident.confidence || 0) * 100);
        const hasLocation =
          incident.formatted_address && incident.latitude && incident.longitude;
        const hasProperty = incident.property_owner || incident.property_price;
        const hasAudio =
          incident.audio_filename && incident.audio_status !== "missing";

        return `
          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-info-circle"></i>
              Core Incident Information
            </div>
            <div class="analytics-grid">
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-hashtag"></i>
                  Incident ID
                </div>
                <div class="analytics-card-value large">${incident.id}</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-clock"></i>
                  Time Recorded
                </div>
                <div class="analytics-card-value">${
                  incident.time_recorded || "N/A"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-calendar"></i>
                  Date Created
                </div>
                <div class="analytics-card-value">${
                  incident.date_created || "N/A"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-tag"></i>
                  Incident Type
                </div>
                <div class="analytics-card-value">${formatIncidentType(
                  incident.incident_type
                )}</div>
              </div>
            </div>
          </div>

          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-microphone"></i>
              Transcript & Audio
            </div>
            <div class="analytics-transcript">
              "${incident.transcript || "No transcript available"}"
            </div>
            <div class="analytics-grid" style="margin-top: 1rem;">
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-percentage"></i>
                  Transcription Confidence
                </div>
                <div class="analytics-card-value">
                  ${confidencePercent}%
                  <span class="analytics-badge ${
                    confidencePercent >= 80
                      ? "success"
                      : confidencePercent >= 60
                      ? "warning"
                      : "error"
                  }" style="margin-left: 0.5rem;">
                    ${
                      confidencePercent >= 80
                        ? "High"
                        : confidencePercent >= 60
                        ? "Medium"
                        : "Low"
                    }
                  </span>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-file-audio"></i>
                  Audio Status
                </div>
                <div class="analytics-card-value">
                  <span class="analytics-badge ${
                    hasAudio ? "success" : "error"
                  }">
                    ${hasAudio ? "✓ Available" : "✗ Missing"}
                  </span>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-file"></i>
                  Audio Filename
                </div>
                <div class="analytics-card-value" style="font-size: 0.8rem; word-break: break-all;">
                  ${incident.audio_filename || incident.filename || "N/A"}
                </div>
              </div>
            </div>
          </div>

          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-broadcast-tower"></i>
              Radio System Information
            </div>
            <div class="analytics-grid">
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-network-wired"></i>
                  System
                </div>
                <div class="analytics-card-value">${
                  incident.system || "Unknown"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-building"></i>
                  Department
                </div>
                <div class="analytics-card-value">${
                  incident.department || "Unknown"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-hashtag"></i>
                  Channel
                </div>
                <div class="analytics-card-value">${
                  incident.channel || "Unknown"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-signal"></i>
                  Frequency
                </div>
                <div class="analytics-card-value">${
                  incident.frequency || "Unknown"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-wave-square"></i>
                  Modulation
                </div>
                <div class="analytics-card-value">${
                  incident.modulation || "N/A"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-id-badge"></i>
                  Talkgroup ID
                </div>
                <div class="analytics-card-value">${
                  incident.tgid || "N/A"
                }</div>
              </div>
            </div>
          </div>

          ${
            hasLocation
              ? `
          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-map-marked-alt"></i>
              Location Intelligence
            </div>
            <div class="analytics-grid">
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-map-pin"></i>
                  Extracted Address
                </div>
                <div class="analytics-card-value">${
                  incident.address || "N/A"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-map-marker-alt"></i>
                  Formatted Address
                </div>
                <div class="analytics-card-value">${
                  incident.formatted_address || "N/A"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-globe"></i>
                  Latitude
                </div>
                <div class="analytics-card-value">${
                  incident.latitude ? incident.latitude.toFixed(6) : "N/A"
                }</div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-globe"></i>
                  Longitude
                </div>
                <div class="analytics-card-value">${
                  incident.longitude ? incident.longitude.toFixed(6) : "N/A"
                }</div>
              </div>
              ${
                incident.maps_link
                  ? `
              <div class="analytics-card" style="grid-column: 1 / -1;">
                <div class="analytics-card-label">
                  <i class="fas fa-external-link-alt"></i>
                  Google Maps
                </div>
                <div class="analytics-card-value">
                  <a href="${incident.maps_link}" target="_blank" class="analytics-link">
                    Open in Google Maps <i class="fas fa-arrow-right"></i>
                  </a>
                </div>
              </div>
              `
                  : ""
              }
              ${
                incident.streetview_url
                  ? `
              <div class="analytics-card" style="grid-column: 1 / -1;">
                <div class="analytics-card-label">
                  <i class="fas fa-street-view"></i>
                  Street View
                </div>
                <div class="analytics-card-value">
                  <a href="${incident.streetview_url}" target="_blank" class="analytics-link">
                    Open Street View <i class="fas fa-arrow-right"></i>
                  </a>
                </div>
              </div>
              `
                  : ""
              }
            </div>
          </div>
          `
              : `
          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-map-marked-alt"></i>
              Location Intelligence
            </div>
            <div style="text-align: center; padding: 2rem; color: var(--light-400);">
              <i class="fas fa-map-pin" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
              <p>No location data available for this incident</p>
            </div>
          </div>
          `
          }

          ${
            hasProperty
              ? `
          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-home"></i>
              Property Information
            </div>
            <div class="analytics-grid">
              ${
                incident.property_owner
                  ? `
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-user"></i>
                  Property Owner
                </div>
                <div class="analytics-card-value">${incident.property_owner}</div>
              </div>
              `
                  : ""
              }
              ${
                incident.property_price
                  ? `
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-dollar-sign"></i>
                  Assessed Value
                </div>
                <div class="analytics-card-value large">$${incident.property_price.toLocaleString()}</div>
              </div>
              `
                  : ""
              }
            </div>
          </div>
          `
              : ""
          }

          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-cogs"></i>
              Processing Pipeline
            </div>
            <div class="analytics-processing-timeline">
              <div class="analytics-timeline-item">
                <div class="analytics-timeline-title">
                  <i class="fas fa-file-audio"></i> Audio Capture
                </div>
                <div class="analytics-timeline-desc">
                  Audio file received from scanner at ${
                    incident.time_recorded || "unknown time"
                  }
                </div>
              </div>
              <div class="analytics-timeline-item">
                <div class="analytics-timeline-title">
                  <i class="fas fa-microphone-alt"></i> Speech-to-Text Transcription
                </div>
                <div class="analytics-timeline-desc">
                  Transcribed with ${confidencePercent}% confidence
                  <span class="analytics-badge ${
                    confidencePercent >= 80
                      ? "success"
                      : confidencePercent >= 60
                      ? "warning"
                      : "error"
                  }" style="margin-left: 0.5rem;">
                    ${
                      confidencePercent >= 80
                        ? "High Quality"
                        : confidencePercent >= 60
                        ? "Medium Quality"
                        : "Low Quality"
                    }
                  </span>
                </div>
              </div>
              <div class="analytics-timeline-item">
                <div class="analytics-timeline-title">
                  <i class="fas fa-robot"></i> AI Classification
                </div>
                <div class="analytics-timeline-desc">
                  Classified as: <strong>${formatIncidentType(
                    incident.incident_type
                  )}</strong>
                </div>
              </div>
              ${
                hasLocation
                  ? `
              <div class="analytics-timeline-item">
                <div class="analytics-timeline-title">
                  <i class="fas fa-map-pin"></i> Location Extraction & Geocoding
                </div>
                <div class="analytics-timeline-desc">
                  Address extracted and geocoded to coordinates (${
                    incident.latitude ? incident.latitude.toFixed(4) : "N/A"
                  }, ${
                      incident.longitude ? incident.longitude.toFixed(4) : "N/A"
                    })
                </div>
              </div>
              `
                  : ""
              }
              ${
                hasProperty
                  ? `
              <div class="analytics-timeline-item">
                <div class="analytics-timeline-title">
                  <i class="fas fa-home"></i> Property Lookup
                </div>
                <div class="analytics-timeline-desc">
                  Property information retrieved from public records
                </div>
              </div>
              `
                  : ""
              }
              <div class="analytics-timeline-item">
                <div class="analytics-timeline-title">
                  <i class="fas fa-check-circle"></i> Processing Complete
                </div>
                <div class="analytics-timeline-desc">
                  Incident ready for display on dashboard
                </div>
              </div>
            </div>
          </div>

          <div class="analytics-section">
            <div class="analytics-section-title">
              <i class="fas fa-database"></i>
              Database Metadata
            </div>
            <div class="analytics-grid">
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-folder"></i>
                  File Path
                </div>
                <div class="analytics-card-value" style="font-size: 0.75rem; word-break: break-all;">
                  ${incident.filepath || "N/A"}
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-label">
                  <i class="fas fa-file-signature"></i>
                  Original Filename
                </div>
                <div class="analytics-card-value" style="font-size: 0.8rem; word-break: break-all;">
                  ${incident.original_filename || incident.filename || "N/A"}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Callsign Lookup Database
      const callSignDatabase = {
        // Patrol Units
        491: "Patrol",
        492: "Patrol",
        493: "Patrol",
        494: "Patrol",
        495: "Patrol",
        496: "Patrol",
        497: "Patrol",
        498: "Patrol",
        499: "Patrol",
        500: "Patrol",
        501: "Patrol",
        502: "Patrol",
        503: "Patrol",
        504: "Patrol",

        // Supervisors & Command
        505: "Patrol Supervisor",
        506: "Patrol Supervisor",
        507: "Patrol Supervisor",
        508: "Patrol Supervisor",
        509: "Detective Commander",
        510: "Internal Affairs",
        511: "IT Bureau Commander",
        512: "Chief of Police",
        513: "Superintendent",
        514: "Detective Bureau Sergeant",
        516: "Detective",
        517: "Detective Bureau Sergeant",
        518: "Detective",
        519: "Detective",

        // Traffic Bureau
        520: "Traffic Bureau Commander",
        521: "Mayor",
        522: "Traffic",
        523: "Traffic",
        524: "Traffic",
        525: "Traffic",
        526: "Traffic",
        527: "Detail Cruiser",
        528: "Detail Cruiser",
        529: "Detail Cruiser",
        530: "Detail Cruiser",
        531: "Traffic Sergeant",
        532: "Patrol Lieutenant (I.O.D.)",
        535: "Safety Officer",
        537: "Commercial Vehicle Enforcement",
        538: "Animal Control",
        540: "Garage Maintenance",

        // Special Operations & Support
        600: "Dispatch Commander",
        602: "Drug Unit/Task Force",
        604: "Community Services",
        610: "Special Operations Vehicle",
        611: "Drug Unit/Task Force",

        // 1300 Series - Community Services
        1301: "Community Services",
        1302: "Community Services",
        1303: "Community Services Bureau Commander",
        1304: "Community Services",
        1305: "Community Services",
        1306: "Parking Control",
        1307: "Parking Control",
        1308: "Parking Control",
        1309: "Parking Control",
        1313: "Drug Unit/Task Force",
        1314: "Detective",
        1315: "Detective",
        1316: "Drug Unit/Task Force",
        1319: "Community Services",
        1320: "Community Services",
        1321: "Community Service Bureau Sergeant",
        1324: "Details Lieutenant",
        1325: "Support Services Bureau Commander",

        // 1200 Series - Special Operations
        1256: "Special Operations Sergeant",
        1257: "Special Operations Lieutenant",
        1258: "Special Operations Bureau Commander",

        // 1300 Series - Patrol Bureau
        1340: "Fourth Platoon",
        1341: "Patrol Bureau Commander",
        1342: "Fourth Platoon",
        1344: "POP Unit",
        1345: "Patrol Bureau Commander",

        // Motorcycles
        MC1: "Motorcycle Unit",
        MC2: "Motorcycle Unit",
        MC3: "Motorcycle Unit",
        MC4: "Motorcycle Unit",
      };

      // Function to identify and enhance callsigns in text
      function enhanceCallsigns(text) {
        if (!text) return text;

        // Pattern to match Newton + number, or just numbers that could be callsigns
        // Look for Newton followed by number, or standalone numbers (3-4 digits)
        const patterns = [
          /\b(Newton\s+)(\d{3,4})\b/gi, // Newton 491, Newton 1256, etc.
          /\b(MC\d)\b/gi, // MC1, MC2, etc.
          /\b(\d{3,4})\b/g, // Standalone 3-4 digit numbers
        ];

        let enhancedText = text;

        // Process each pattern
        patterns.forEach((pattern) => {
          enhancedText = enhancedText.replace(
            pattern,
            (match, prefix, number) => {
              // For "Newton XXX" pattern
              if (prefix && prefix.toLowerCase().includes("newton")) {
                const callsignInfo = callSignDatabase[number];
                if (callsignInfo) {
                  return `${prefix}<span class="callsign-tooltip" onclick="jumpToLastCallsign('${number}')">${number}<span class="callsign-tooltip-content"><i class="fas fa-id-badge"></i> ${callsignInfo}<span class="tooltip-hint">Click to find last use</span></span></span>`;
                }
                return match;
              }

              // For "MCX" pattern
              if (match.match(/^MC\d$/i)) {
                const callsignInfo = callSignDatabase[match.toUpperCase()];
                if (callsignInfo) {
                  return `<span class="callsign-tooltip" onclick="jumpToLastCallsign('${match.toUpperCase()}')">${match}<span class="callsign-tooltip-content"><i class="fas fa-id-badge"></i> ${callsignInfo}<span class="tooltip-hint">Click to find last use</span></span></span>`;
                }
                return match;
              }

              // For standalone numbers - only enhance if it's a known callsign
              const callsignInfo = callSignDatabase[match];
              if (callsignInfo) {
                return `<span class="callsign-tooltip" onclick="jumpToLastCallsign('${match}')">${match}<span class="callsign-tooltip-content"><i class="fas fa-id-badge"></i> ${callsignInfo}<span class="tooltip-hint">Click to find last use</span></span></span>`;
              }

              return match;
            }
          );
        });

        return enhancedText;
      }

      // Function to find and jump to the last incident containing a specific callsign
      function jumpToLastCallsign(callsign) {
        console.log(`🔍 Searching for previous use of callsign: ${callsign}`);

        // Get the current incident card that was clicked
        const clickedElement = event.target.closest(".incident-card");
        const currentIncidentId = clickedElement
          ? parseInt(clickedElement.dataset.incidentId)
          : null;

        console.log(`Current incident ID: ${currentIncidentId}`);

        // Get all incidents from allIncidents array (sorted by time, newest first)
        if (!allIncidents || allIncidents.length === 0) {
          showNotification(
            `No incidents found with callsign ${callsign}`,
            "info"
          );
          return;
        }

        // Search through incidents to find the PREVIOUS one with this callsign (older than current)
        let foundIncident = null;
        let foundCurrentIncident = false;

        for (let i = 0; i < allIncidents.length; i++) {
          const incident = allIncidents[i];
          const transcript = incident.transcript || "";

          // Create regex patterns to match the callsign
          const patterns = [
            new RegExp(`\\bNewton\\s+${callsign}\\b`, "i"), // Newton 498
            new RegExp(`\\b${callsign}\\b`, "i"), // Standalone 498
          ];

          // Check if any pattern matches
          const hasCallsign = patterns.some((pattern) =>
            pattern.test(transcript)
          );

          if (hasCallsign) {
            // If this is the current incident, mark it and continue searching
            if (incident.id === currentIncidentId) {
              foundCurrentIncident = true;
              console.log(
                `Found current incident at index ${i}, continuing search...`
              );
              continue; // Skip to next incident
            }

            // If we already passed the current incident, this is the previous one
            if (foundCurrentIncident || currentIncidentId === null) {
              foundIncident = incident;
              console.log(
                `Found previous incident ${incident.id} at index ${i}`
              );
              break;
            }
          }
        }

        if (foundIncident) {
          console.log(
            `✅ Found previous incident ${foundIncident.id} with callsign ${callsign}`
          );

          // Find the incident element in the DOM
          const incidentElement = document.querySelector(
            `[data-incident-id="${foundIncident.id}"]`
          );

          if (incidentElement) {
            // Scroll to the incident
            incidentElement.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });

            // Add highlight effect
            const originalBackground = incidentElement.style.backgroundColor;
            const originalBorder = incidentElement.style.border;
            const originalTransform = incidentElement.style.transform;
            const originalBoxShadow = incidentElement.style.boxShadow;
            const originalTransformOrigin =
              incidentElement.style.transformOrigin;

            incidentElement.style.backgroundColor = "rgba(59, 130, 246, 0.2)";
            incidentElement.style.border = "2px solid var(--accent-blue)";
            incidentElement.style.transform = "scale(1.02)";
            incidentElement.style.transformOrigin = "center center";
            incidentElement.style.transition = "all 0.3s ease";
            incidentElement.style.boxShadow =
              "0 4px 20px rgba(59, 130, 246, 0.4)";

            // Show notification
            const callsignInfo = callSignDatabase[callsign];
            showNotification(
              `📍 Found previous use: ${callsign} (${callsignInfo}) at ${foundIncident.time_recorded}`,
              "success"
            );

            // Reset styling after 3 seconds
            setTimeout(() => {
              incidentElement.style.backgroundColor = originalBackground;
              incidentElement.style.border = originalBorder;
              incidentElement.style.transform = originalTransform;
              incidentElement.style.boxShadow = originalBoxShadow;
              incidentElement.style.transformOrigin = originalTransformOrigin;
            }, 3000);
          } else {
            // Incident exists but not currently displayed (filtered out)
            const callsignInfo = callSignDatabase[callsign];
            showNotification(
              `Found ${callsign} (${callsignInfo}) but it's filtered out. Show all incidents to see it.`,
              "warning"
            );
          }
        } else {
          const callsignInfo = callSignDatabase[callsign];
          if (foundCurrentIncident) {
            showNotification(
              `No earlier incidents found with callsign ${callsign} (${callsignInfo})`,
              "info"
            );
          } else {
            showNotification(
              `No incidents found with callsign ${callsign} (${callsignInfo})`,
              "info"
            );
          }
        }
      }

      // Close modal when clicking outside of it
      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("callsignModal");
        if (modal) {
          modal.addEventListener("click", function (e) {
            if (e.target === modal) {
              closeCallsignModal();
            }
          });
        }

        const analyticsModal = document.getElementById("analyticsModal");
        if (analyticsModal) {
          analyticsModal.addEventListener("click", function (e) {
            if (e.target === analyticsModal) {
              closeAnalyticsModal();
            }
          });
        }

        // Close modals with Escape key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeCallsignModal();
            closeAnalyticsModal();
          }
        });
      });
    </script>

    <!-- Callsign Reference Modal -->
    <div id="callsignModal" class="callsign-modal">
      <div class="callsign-modal-content">
        <div class="callsign-modal-header">
          <h2>
            <i class="fas fa-id-badge"></i>
            Newton Police Call Signs Reference
          </h2>
          <button class="callsign-modal-close" onclick="closeCallsignModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="callsign-modal-body">
          <!-- Patrol Units -->
          <div class="callsign-category">
            <div class="callsign-category-title">
              <i class="fas fa-car"></i>
              Patrol Units
            </div>
            <div class="callsign-grid">
              <div class="callsign-item">
                <div class="callsign-number">491-504</div>
                <div class="callsign-description">Patrol</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">Centre</div>
                <div class="callsign-description">
                  Newton Centre Square Foot Route
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">Newtonville</div>
                <div class="callsign-description">
                  Newtonville Square Foot Route
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">Auburndale</div>
                <div class="callsign-description">
                  Auburndale Square Foot Route
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">Corner</div>
                <div class="callsign-description">
                  Newton Corner Square Foot Route
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">Highlands</div>
                <div class="callsign-description">
                  Newton Highlands Square Foot Route
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">West Newton</div>
                <div class="callsign-description">
                  West Newton Square Foot Route
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">Nonantum</div>
                <div class="callsign-description">
                  Nonantum Square Foot Route
                </div>
              </div>
            </div>
          </div>

          <!-- Supervisors & Command -->
          <div class="callsign-category">
            <div class="callsign-category-title">
              <i class="fas fa-star"></i>
              Supervisors & Command Staff
            </div>
            <div class="callsign-grid">
              <div class="callsign-item">
                <div class="callsign-number">505-508</div>
                <div class="callsign-description">Patrol Supervisor</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">512</div>
                <div class="callsign-description">Chief of Police</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">513</div>
                <div class="callsign-description">Superintendent</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">521</div>
                <div class="callsign-description">Mayor</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">532</div>
                <div class="callsign-description">
                  Patrol Lieutenant (I.O.D.)
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">535</div>
                <div class="callsign-description">Safety Officer</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1341</div>
                <div class="callsign-description">Patrol Bureau Commander</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1345</div>
                <div class="callsign-description">Patrol Bureau Commander</div>
              </div>
            </div>
          </div>

          <!-- Detective Bureau -->
          <div class="callsign-category">
            <div class="callsign-category-title">
              <i class="fas fa-user-secret"></i>
              Detective Bureau
            </div>
            <div class="callsign-grid">
              <div class="callsign-item">
                <div class="callsign-number">509</div>
                <div class="callsign-description">Detective Commander</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">514</div>
                <div class="callsign-description">
                  Detective Bureau Sergeant
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">517</div>
                <div class="callsign-description">
                  Detective Bureau Sergeant
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">516</div>
                <div class="callsign-description">Detective</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">518</div>
                <div class="callsign-description">Detective</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">519</div>
                <div class="callsign-description">Detective</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1314</div>
                <div class="callsign-description">Detective</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1315</div>
                <div class="callsign-description">Detective</div>
              </div>
            </div>
          </div>

          <!-- Traffic Bureau -->
          <div class="callsign-category">
            <div class="callsign-category-title">
              <i class="fas fa-traffic-light"></i>
              Traffic Bureau
            </div>
            <div class="callsign-grid">
              <div class="callsign-item">
                <div class="callsign-number">520</div>
                <div class="callsign-description">Traffic Bureau Commander</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">531</div>
                <div class="callsign-description">Traffic Sergeant</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">522-526</div>
                <div class="callsign-description">Traffic</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">537-530</div>
                <div class="callsign-description">Detail Cruisers</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">537</div>
                <div class="callsign-description">
                  Commercial Vehicle Enforcement
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">MC1-MC4</div>
                <div class="callsign-description">Motorcycles</div>
              </div>
            </div>
          </div>

          <!-- Special Units -->
          <div class="callsign-category">
            <div class="callsign-category-title">
              <i class="fas fa-shield-alt"></i>
              Special Operations & Units
            </div>
            <div class="callsign-grid">
              <div class="callsign-item">
                <div class="callsign-number">510</div>
                <div class="callsign-description">Internal Affairs</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">511</div>
                <div class="callsign-description">
                  Information Technology Bureau Commander
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">538</div>
                <div class="callsign-description">Animal Control</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">540</div>
                <div class="callsign-description">Garage Maintenance Truck</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">600</div>
                <div class="callsign-description">Dispatch Commander</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">610</div>
                <div class="callsign-description">
                  Special Operations Vehicle
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1256</div>
                <div class="callsign-description">
                  Special Operations Sergeant
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1257</div>
                <div class="callsign-description">
                  Special Operations Lieutenant
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1258</div>
                <div class="callsign-description">
                  Special Operations Bureau Commander
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1313</div>
                <div class="callsign-description">Drug Unit/Task Force</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1316</div>
                <div class="callsign-description">Drug Unit/Task Force</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">602</div>
                <div class="callsign-description">Drug Unit/Task Force</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">611</div>
                <div class="callsign-description">Drug Unit/Task Force</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1324</div>
                <div class="callsign-description">Details Lieutenant</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1325</div>
                <div class="callsign-description">
                  Support Services Bureau Commander
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1340</div>
                <div class="callsign-description">Fourth Platoon</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1342</div>
                <div class="callsign-description">Fourth Platoon</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1344</div>
                <div class="callsign-description">POP Unit</div>
              </div>
            </div>
          </div>

          <!-- Community Services -->
          <div class="callsign-category">
            <div class="callsign-category-title">
              <i class="fas fa-users"></i>
              Community Services
            </div>
            <div class="callsign-grid">
              <div class="callsign-item">
                <div class="callsign-number">1303</div>
                <div class="callsign-description">
                  Community Services Bureau Commander
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1321</div>
                <div class="callsign-description">
                  Community Service Bureau Sergeant
                </div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1301</div>
                <div class="callsign-description">Community Services</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1302</div>
                <div class="callsign-description">Community Services</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1304</div>
                <div class="callsign-description">Community Services</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1305</div>
                <div class="callsign-description">Community Services</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1319</div>
                <div class="callsign-description">Community Services</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1320</div>
                <div class="callsign-description">Community Services</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">604</div>
                <div class="callsign-description">Community Services</div>
              </div>
              <div class="callsign-item">
                <div class="callsign-number">1306-1309</div>
                <div class="callsign-description">Parking Control</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="analytics-modal">
      <div class="analytics-modal-content">
        <div class="analytics-modal-header">
          <h2 class="analytics-modal-title">
            <i class="fas fa-chart-line"></i>
            Incident Analytics
          </h2>
          <button class="analytics-modal-close" onclick="closeAnalyticsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="analytics-modal-body" id="analyticsModalContent">
          <!-- Content will be dynamically generated -->
        </div>
      </div>
    </div>
  </body>
</html>
